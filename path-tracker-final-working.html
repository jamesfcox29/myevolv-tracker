<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PATH Entry Tracker v4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        h1 { color: #333; font-size: 1.8em; margin-bottom: 10px; }
        .version { color: #667eea; font-size: 0.9em; font-weight: bold; }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 0.85em;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            padding: 8px 0;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            margin-right: 8px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #51cf66; color: white; }
        .btn-danger { background: #ff6b6b; color: white; }
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 { font-size: 1.8em; margin-bottom: 5px; }
        .stat-card p { font-size: 0.85em; }
        .filters {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            background: white;
            font-size: 0.85em;
        }
        th {
            background: #667eea;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            margin: 2px;
        }
        .edit-btn { background: #4dabf7; color: white; }
        .delete-btn { background: #ff6b6b; color: white; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
        }
        .login-container h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .flag-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin: 2px;
        }
        .flag-ce { background: #ffd700; color: #856404; }
        .flag-youth { background: #ff6b6b; color: white; }
        .flag-active-voucher { background: #51cf66; color: white; }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        var sbUrl = 'https://wvvepssoltooeeqqvnul.supabase.co';
        var sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2dmVwc3NvbHRvb2VlcXF2bnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDA3MDgsImV4cCI6MjA4MzcxNjcwOH0.xPFDECNheYPrxYTBfQ3IwbUY27UNfqMMojBvnB6ArnQ';
        var sb = window.supabase.createClient(sbUrl, sbKey);
        var user = null;
        var entries = [];
        var editing = null;

        window.onload = function() {
            init();
        };

        function init() {
            sb.auth.getSession().then(function(result) {
                if (result.data.session) { 
                    user = result.data.session.user; 
                    renderApp(); 
                    loadEntries(); 
                } else { 
                    renderLogin(); 
                }
            });
            
            sb.auth.onAuthStateChange(function(event, session) {
                if (session) { 
                    user = session.user; 
                    renderApp(); 
                    loadEntries(); 
                } else { 
                    user = null; 
                    renderLogin(); 
                }
            });
        }

        function renderLogin() {
            document.getElementById('app').innerHTML = '<div class="login-container"><h2>ðŸ”’ PATH Entry Tracker v4.1</h2><div class="form-group"><label>Email</label><input type="email" id="loginEmail"></div><div class="form-group" style="margin-top:15px;"><label>Password</label><input type="password" id="loginPassword"></div><div class="button-group" style="margin-top:20px;justify-content:center;"><button class="btn btn-primary" onclick="doLogin()">Login</button><button class="btn btn-secondary" onclick="doSignup()">Sign Up</button></div><div id="authMsg"></div></div>';
        }

        function doLogin() {
            var email = document.getElementById('loginEmail').value;
            var password = document.getElementById('loginPassword').value;
            sb.auth.signInWithPassword({ email: email, password: password }).then(function(result) {
                if (result.error) {
                    document.getElementById('authMsg').innerHTML = '<p style="color:red;margin-top:10px;">' + result.error.message + '</p>';
                }
            });
        }

        function doSignup() {
            var email = document.getElementById('loginEmail').value;
            var password = document.getElementById('loginPassword').value;
            sb.auth.signUp({ email: email, password: password }).then(function(result) {
                if (result.error) {
                    document.getElementById('authMsg').innerHTML = '<p style="color:red;margin-top:10px;">' + result.error.message + '</p>';
                } else {
                    document.getElementById('authMsg').innerHTML = '<p style="color:green;margin-top:10px;">Check your email!</p>';
                }
            });
        }

        function doLogout() { 
            sb.auth.signOut(); 
        }

        function renderApp() {
            var html = '<div class="container"><div class="header"><h1>ðŸ“‹ PATH Entry Tracker</h1><p class="version">Version 4.1</p></div><div class="user-info"><span>ðŸ‘¤ ' + user.email + '</span><button class="btn btn-secondary" onclick="doLogout()">Logout</button></div><div id="stats"></div><div class="form-section"><h2>âž• Add/Edit Entry</h2><form id="entryForm" onsubmit="return saveEntry(event)"><div class="form-grid"><div class="form-group"><label>Client Name *</label><input type="text" id="clientName" required></div><div class="form-group"><label>DOB *</label><input type="date" id="dob" required></div><div class="form-group"><label>HMIS ID</label><input type="text" id="hmisId"></div><div class="form-group"><label>Case Manager</label><input type="text" id="caseManager"></div></div><div class="form-grid"><div class="form-group"><label>Entry Type *</label><select id="entryType" required><option value="">Select</option><option value="Stand-alone CE">Stand-alone CE</option><option value="Internal Referral">Internal Referral</option><option value="External Referral">External Referral</option><option value="HMIS Entry">HMIS Entry</option><option value="MyEvolv Entry">MyEvolv Entry</option></select></div><div class="form-group"><label>System *</label><select id="system" required><option value="">Select</option><option value="MyEvolv">MyEvolv</option><option value="HMIS">HMIS</option><option value="Both">Both</option></select></div><div class="form-group"><label>Enrollment *</label><select id="enrollment" required><option value="">Select</option><option value="Fully Enrolled">Fully Enrolled</option><option value="Partially Enrolled">Partially Enrolled</option></select></div><div class="form-group"><label>Encounter Date</label><input type="date" id="encounterDate"></div></div><div class="form-grid"><div class="form-group"><label>Living Situation</label><input type="text" id="living"></div><div class="form-group"><label>Voucher Type</label><select id="voucherType"><option value="None">None</option><option value="COB">COB</option><option value="PSHP">PSHP</option><option value="Section 8">Section 8</option></select></div><div class="form-group"><label>Voucher Status</label><select id="voucherStatus"><option value="Inactive">Inactive</option><option value="Pending">Pending</option><option value="Active">Active</option></select></div><div class="form-group"><label>Insurance</label><select id="insurance"><option value="None">None</option><option value="MaineCare">MaineCare</option><option value="Private">Private</option><option value="Medicare">Medicare</option></select></div></div><div class="form-grid"><div class="form-group"><label>Diagnosis</label><input type="text" id="diagnosis"></div><div class="form-group"><label>Diagnosis Date</label><input type="date" id="dxDate"></div></div><div class="form-group"><label>Documents Ready</label><div class="checkbox-group"><div class="checkbox-item"><input type="checkbox" id="docSS"><label for="docSS">Social Security</label></div><div class="checkbox-item"><input type="checkbox" id="docID"><label for="docID">ID</label></div><div class="checkbox-item"><input type="checkbox" id="docBirth"><label for="docBirth">Birth Certificate</label></div></div></div><div class="form-group"><label>Notes</label><textarea id="notes"></textarea></div><div class="button-group"><button type="submit" class="btn btn-primary" id="submitBtn">Add Entry</button><button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button></div></form></div><div><h2 style="margin-bottom:15px;">ðŸ“Š Entries & Reports</h2><div class="filters"><h3 style="margin-bottom:10px;">Filters</h3><div class="filter-grid"><div class="form-group"><label>Month</label><input type="month" id="fMonth"></div><div class="form-group"><label>Entry Type</label><select id="fType"><option value="">All</option><option value="Stand-alone CE">Stand-alone CE</option><option value="Internal Referral">Internal Referral</option><option value="External Referral">External Referral</option><option value="HMIS Entry">HMIS Entry</option><option value="MyEvolv Entry">MyEvolv Entry</option></select></div><div class="form-group"><label>System</label><select id="fSystem"><option value="">All</option><option value="MyEvolv">MyEvolv</option><option value="HMIS">HMIS</option><option value="Both">Both</option></select></div><div class="form-group"><label>Enrollment</label><select id="fEnrollment"><option value="">All</option><option value="Fully Enrolled">Fully</option><option value="Partially Enrolled">Partial</option></select></div><div class="form-group"><label>Voucher Status</label><select id="fVoucher"><option value="">All</option><option value="Active">Active</option><option value="Pending">Pending</option><option value="Inactive">Inactive</option></select></div></div><div class="checkbox-group" style="margin-top:10px;"><div class="checkbox-item"><input type="checkbox" id="fCE"><label for="fCE">CE Only</label></div><div class="checkbox-item"><input type="checkbox" id="fYouth"><label for="fYouth">Youth (14-16)</label></div><div class="checkbox-item"><input type="checkbox" id="fActiveV"><label for="fActiveV">Active Vouchers</label></div></div><div class="button-group" style="margin-top:10px;"><button class="btn btn-primary" onclick="applyFilters()">Apply</button><button class="btn btn-secondary" onclick="clearFilters()">Clear</button><button class="btn btn-success" onclick="exportCSV()">Export CSV</button></div></div><div class="table-container"><div id="table"></div></div></div></div>';
            document.getElementById('app').innerHTML = html;
            var now = new Date();
            var month = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
            document.getElementById('fMonth').value = month;
        }

        function calcAge(dob) {
            var bd = new Date(dob);
            var today = new Date();
            var age = today.getFullYear() - bd.getFullYear();
            var m = today.getMonth() - bd.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) {
                age = age - 1;
            }
            return age;
        }

        function isYouth(dob) {
            var age = calcAge(dob);
            return age >= 14 && age <= 16;
        }

        function saveEntry(e) {
            e.preventDefault();
            
            var clientNameEl = document.getElementById('clientName');
            var dobEl = document.getElementById('dob');
            var hmisIdEl = document.getElementById('hmisId');
            var caseManagerEl = document.getElementById('caseManager');
            var entryTypeEl = document.getElementById('entryType');
            var systemEl = document.getElementById('system');
            var enrollmentEl = document.getElementById('enrollment');
            var encounterDateEl = document.getElementById('encounterDate');
            var livingEl = document.getElementById('living');
            var voucherTypeEl = document.getElementById('voucherType');
            var voucherStatusEl = document.getElementById('voucherStatus');
            var insuranceEl = document.getElementById('insurance');
            var diagnosisEl = document.getElementById('diagnosis');
            var dxDateEl = document.getElementById('dxDate');
            var docSSEl = document.getElementById('docSS');
            var docIDEl = document.getElementById('docID');
            var docBirthEl = document.getElementById('docBirth');
            var notesEl = document.getElementById('notes');
            
            var data = {
                client_name: clientNameEl.value,
                dob: dobEl.value,
                hmis_id: hmisIdEl.value,
                case_manager: caseManagerEl.value,
                entry_type: entryTypeEl.value,
                system: systemEl.value,
                enrollment_status: enrollmentEl.value,
                encounter_date: encounterDateEl.value,
                living_situation: livingEl.value,
                voucher_type: voucherTypeEl.value,
                voucher_status: voucherStatusEl.value,
                insurance: insuranceEl.value,
                diagnosis: diagnosisEl.value,
                diagnosis_date: dxDateEl.value,
                doc_ss: docSSEl.checked,
                doc_id: docIDEl.checked,
                doc_birth: docBirthEl.checked,
                notes: notesEl.value,
                user_id: user.id
            };
            
            if (editing) {
                sb.from('myevolv_entries').update(data).eq('id', editing.id).then(function(result) {
                    if (result.error) {
                        alert('Error: ' + result.error.message);
                    } else {
                        alert('Updated!');
                        editing = null;
                        document.getElementById('submitBtn').textContent = 'Add Entry';
                        resetForm();
                        loadEntries();
                    }
                });
            } else {
                sb.from('myevolv_entries').insert([data]).then(function(result) {
                    if (result.error) {
                        alert('Error: ' + result.error.message);
                    } else {
                        alert('Added!');
                        resetForm();
                        loadEntries();
                    }
                });
            }
            
            return false;
        }

        function resetForm() {
            document.getElementById('entryForm').reset();
            editing = null;
            document.getElementById('submitBtn').textContent = 'Add Entry';
        }

        function loadEntries() {
            sb.from('myevolv_entries').select('*').order('created_at', { ascending: false }).then(function(result) {
                if (result.error) {
                    document.getElementById('table').innerHTML = '<p style="color:red;">' + result.error.message + '</p>';
                } else {
                    entries = result.data || [];
                    applyFilters();
                    updateStats();
                }
            });
        }

        function updateStats() {
            var total = entries.length;
            var full = 0;
            var active = 0;
            var youth = 0;
            for (var i = 0; i < entries.length; i++) {
                if (entries[i].enrollment_status === 'Fully Enrolled') full++;
                if (entries[i].voucher_status === 'Active') active++;
                if (isYouth(entries[i].dob)) youth++;
            }
            var html = '<div class="stats-grid"><div class="stat-card"><h3>' + total + '</h3><p>Total</p></div><div class="stat-card"><h3>' + full + '</h3><p>Fully Enrolled</p></div><div class="stat-card"><h3>' + active + '</h3><p>Active Vouchers</p></div><div class="stat-card"><h3>' + youth + '</h3><p>Youth (14-16)</p></div></div>';
            document.getElementById('stats').innerHTML = html;
        }

        function applyFilters() {
            var filtered = entries.slice();
            var month = document.getElementById('fMonth').value;
            if (month) {
                filtered = filtered.filter(function(e) {
                    var d = e.encounter_date || e.created_at;
                    return d && d.indexOf(month) === 0;
                });
            }
            var type = document.getElementById('fType').value;
            if (type) filtered = filtered.filter(function(e) { return e.entry_type === type; });
            var sys = document.getElementById('fSystem').value;
            if (sys) filtered = filtered.filter(function(e) { return e.system === sys; });
            var enr = document.getElementById('fEnrollment').value;
            if (enr) filtered = filtered.filter(function(e) { return e.enrollment_status === enr; });
            var vou = document.getElementById('fVoucher').value;
            if (vou) filtered = filtered.filter(function(e) { return e.voucher_status === vou; });
            if (document.getElementById('fCE').checked) filtered = filtered.filter(function(e) { return e.entry_type === 'Stand-alone CE'; });
            if (document.getElementById('fYouth').checked) filtered = filtered.filter(function(e) { return isYouth(e.dob); });
            if (document.getElementById('fActiveV').checked) filtered = filtered.filter(function(e) { return e.voucher_status === 'Active'; });
            renderTable(filtered);
        }

        function clearFilters() {
            document.getElementById('fMonth').value = '';
            document.getElementById('fType').value = '';
            document.getElementById('fSystem').value = '';
            document.getElementById('fEnrollment').value = '';
            document.getElementById('fVoucher').value = '';
            document.getElementById('fCE').checked = false;
            document.getElementById('fYouth').checked = false;
            document.getElementById('fActiveV').checked = false;
            applyFilters();
        }

        function renderTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('table').innerHTML = '<p style="text-align:center;padding:20px;color:#667eea;">No entries found</p>';
                return;
            }
            var rows = '';
            for (var i = 0; i < data.length; i++) {
                var e = data[i];
                var age = calcAge(e.dob);
                var youth = isYouth(e.dob);
                var activeV = e.voucher_status === 'Active';
                var ce = e.entry_type === 'Stand-alone CE';
                var docs = [];
                if (e.doc_ss) docs.push('SS');
                if (e.doc_id) docs.push('ID');
                if (e.doc_birth) docs.push('BC');
                var flags = '';
                if (ce) flags += '<span class="flag-indicator flag-ce">CE</span>';
                if (youth) flags += '<span class="flag-indicator flag-youth">Youth</span>';
                if (activeV) flags += '<span class="flag-indicator flag-active-voucher">Active</span>';
                rows += '<tr><td><strong>' + e.client_name + '</strong></td><td>' + e.dob + ' (' + age + ')</td><td>' + (e.hmis_id || '-') + '</td><td>' + (e.case_manager || '-') + '</td><td>' + e.entry_type + '</td><td>' + e.system + '</td><td>' + e.enrollment_status + '</td><td>' + (e.living_situation || '-') + '</td><td>' + e.voucher_type + '</td><td>' + e.voucher_status + '</td><td>' + e.insurance + '</td><td>' + (e.diagnosis || '-') + (e.diagnosis_date ? '<br><small>'+e.diagnosis_date+'</small>' : '') + '</td><td>' + (docs.length ? docs.join(', ') : 'None') + '</td><td>' + (flags || '-') + '</td><td><button class="action-btn edit-btn" onclick="editEntry(' + e.id + ')">Edit</button><button class="action-btn delete-btn" onclick="deleteEntry(' + e.id + ')">Delete</button></td></tr>';
            }
            var html = '<table><thead><tr><th>Name</th><th>DOB</th><th>HMIS ID</th><th>Case Mgr</th><th>Type</th><th>System</th><th>Enrollment</th><th>Living</th><th>Voucher</th><th>Status</th><th>Insurance</th><th>Diagnosis</th><th>Docs</th><th>Flags</th><th>Actions</th></tr></thead><tbody>' + rows + '</tbody></table>';
            document.getElementById('table').innerHTML = html;
        }

        function editEntry(id) {
            var e = null;
            for (var i = 0; i < entries.length; i++) {
                if (entries[i].id === id) {
                    e = entries[i];
                    break;
                }
            }
            if (!e) return;
            editing = e;
            document.getElementById('clientName').value = e.client_name || '';
            document.getElementById('dob').value = e.dob || '';
            document.getElementById('hmisId').value = e.hmis_id || '';
            document.getElementById('caseManager').value = e.case_manager || '';
            document.getElementById('entryType').value = e.entry_type || '';
            document.getElementById('system').value = e.system || '';
            document.getElementById('enrollment').value = e.enrollment_status || '';
            document.getElementById('encounterDate').value = e.encounter_date || '';
            document.getElementById('living').value = e.living_situation || '';
            document.getElementById('voucherType').value = e.voucher_type || 'None';
            document.getElementById('voucherStatus').value = e.voucher_status || 'Inactive';
            document.getElementById('insurance').value = e.insurance || 'None';
            document.getElementById('diagnosis').value = e.diagnosis || '';
            document.getElementById('dxDate').value = e.diagnosis_date || '';
            document.getElementById('docSS').checked = e.doc_ss || false;
            document.getElementById('docID').checked = e.doc_id || false;
            document.getElementById('docBirth').checked = e.doc_birth || false;
            document.getElementById('notes').value = e.notes || '';
            document.getElementById('submitBtn').textContent = 'Update Entry';
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteEntry(id) {
            if (!confirm('Delete this entry?')) return;
            sb.from('myevolv_entries').delete().eq('id', id).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error.message);
                } else {
                    alert('Deleted!');
                    loadEntries();
                }
            });
        }

        function exportCSV() {
            alert('CSV export functionality - add if needed');
        }
    </script>
</body>
</html>