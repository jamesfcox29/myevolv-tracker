<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PATH Tracker v4.2</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 100%; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; }
.header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }
h1 { color: #333; font-size: 1.8em; }
.version { color: #667eea; font-size: 0.9em; }
.user-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; }
.form-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.form-section h2 { color: #667eea; margin-bottom: 15px; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; }
.form-group { display: flex; flex-direction: column; }
.form-group label { font-weight: 600; margin-bottom: 5px; font-size: 0.85em; }
.form-group input, .form-group select, .form-group textarea { padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; }
.form-group textarea { min-height: 60px; }
.checkbox-group { display: flex; gap: 15px; padding: 8px 0; }
.btn { padding: 10px 25px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; margin-right: 8px; }
.btn-primary { background: #667eea; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-success { background: #51cf66; color: white; }
.btn-danger { background: #ff6b6b; color: white; }
.button-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; }
.stat-card h3 { font-size: 1.8em; }
.filters { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
.table-container { overflow-x: auto; margin-top: 15px; }
table { width: 100%; min-width: 1200px; border-collapse: collapse; font-size: 0.85em; }
th { background: #667eea; color: white; padding: 10px 8px; text-align: left; }
td { padding: 8px; border-bottom: 1px solid #eee; }
tr:hover { background: #f8f9fa; }
.action-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; margin: 2px; }
.edit-btn { background: #4dabf7; color: white; }
.delete-btn { background: #ff6b6b; color: white; }
.login-container { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; }
.error-msg { background: #ffe0e0; color: #c00; padding: 10px; border-radius: 6px; margin-top: 10px; }
.success-msg { background: #e0ffe0; color: #080; padding: 10px; border-radius: 6px; margin-top: 10px; }
</style>
</head>
<body>
<div id="app"></div>
<script>
var sb = window.supabase.createClient('https://wvvepssoltooeeqqvnul.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2dmVwc3NvbHRvb2VlcXF2bnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDA3MDgsImV4cCI6MjA4MzcxNjcwOH0.xPFDECNheYPrxYTBfQ3IwbUY27UNfqMMojBvnB6ArnQ');
var user = null;
var entries = [];
var editing = null;

function init() {
  sb.auth.getSession().then(function(r) {
    if (r.data.session) {
      user = r.data.session.user;
      renderApp();
      loadEntries();
    } else {
      renderLogin();
    }
  });
  sb.auth.onAuthStateChange(function(e, s) {
    if (s) { user = s.user; renderApp(); loadEntries(); }
    else { user = null; renderLogin(); }
  });
}

function renderLogin() {
  document.getElementById('app').innerHTML = '<div class="login-container"><h2>PATH Tracker</h2><div class="form-group"><label>Email</label><input type="email" id="loginEmail"></div><div class="form-group" style="margin-top:15px;"><label>Password</label><input type="password" id="loginPassword"></div><div class="button-group" style="justify-content:center;"><button class="btn btn-primary" onclick="doLogin()">Login</button><button class="btn btn-secondary" onclick="doSignup()">Sign Up</button></div><div id="authMsg"></div></div>';
}

function doLogin() {
  var e = document.getElementById('loginEmail').value;
  var p = document.getElementById('loginPassword').value;
  
  // Manager hardcoded login
  if (e === 'kheidemann@chcs-me.org' && p === 'SwayzeeMae711!') {
    user = { id: 'manager', email: 'kheidemann@chcs-me.org', isManager: true };
    renderApp();
    loadEntries();
    return;
  }
  
  sb.auth.signInWithPassword({email:e,password:p}).then(function(r) {
    if (r.error) document.getElementById('authMsg').innerHTML = '<p style="color:red;">'+r.error.message+'</p>';
  });
}

function doSignup() {
  var e = document.getElementById('loginEmail').value;
  var p = document.getElementById('loginPassword').value;
  sb.auth.signUp({email:e,password:p}).then(function(r) {
    if (r.error) document.getElementById('authMsg').innerHTML = '<p style="color:red;">'+r.error.message+'</p>';
    else document.getElementById('authMsg').innerHTML = '<p style="color:green;">Check email!</p>';
  });
}

function doLogout() { sb.auth.signOut(); }

function renderApp() {
  var h = '<div class="container"><div class="header"><h1>PATH Tracker</h1><p class="version">v4.2</p></div>';
  h += '<div class="user-info"><span>'+user.email+'</span><button class="btn btn-secondary" onclick="doLogout()">Logout</button></div>';
  h += '<div id="stats"></div>';
  h += '<div class="form-section"><h2>Add/Edit Entry</h2><div id="formMsg"></div><form id="entryForm"><div class="form-grid">';
  h += '<div class="form-group"><label>Name *</label><input type="text" id="clientName" required></div>';
  h += '<div class="form-group"><label>DOB *</label><input type="date" id="dob" required></div>';
  h += '<div class="form-group"><label>HMIS ID</label><input type="text" id="hmisId"></div>';
  h += '<div class="form-group"><label>Case Manager</label><input type="text" id="caseManager"></div></div>';
  h += '<div class="form-grid">';
  h += '<div class="form-group"><label>Entry Type *</label><select id="entryType" required><option value="">Select</option><option value="Stand-alone CE">Stand-alone CE</option><option value="Internal Referral">Internal Referral</option><option value="External Referral">External Referral</option><option value="HMIS Entry">HMIS Entry</option><option value="MyEvolv Entry">MyEvolv Entry</option></select></div>';
  h += '<div class="form-group"><label>System *</label><select id="system" required><option value="">Select</option><option value="MyEvolv">MyEvolv</option><option value="HMIS">HMIS</option><option value="Both">Both</option></select></div>';
  h += '<div class="form-group"><label>Enrollment *</label><select id="enrollment" required><option value="">Select</option><option value="Fully Enrolled">Fully Enrolled</option><option value="Partially Enrolled">Partially Enrolled</option></select></div>';
  h += '<div class="form-group"><label>Encounter</label><input type="date" id="encounterDate"></div></div>';
  h += '<div class="form-grid">';
  h += '<div class="form-group"><label>Living</label><input type="text" id="living"></div>';
  h += '<div class="form-group"><label>Voucher</label><select id="voucherType"><option value="None">None</option><option value="COB">COB</option><option value="PSHP">PSHP</option><option value="Section 8">Section 8</option></select></div>';
  h += '<div class="form-group"><label>Status</label><select id="voucherStatus"><option value="Inactive">Inactive</option><option value="Pending">Pending</option><option value="Active">Active</option></select></div>';
  h += '<div class="form-group"><label>Insurance</label><select id="insurance"><option value="None">None</option><option value="MaineCare">MaineCare</option><option value="Private">Private</option><option value="Medicare">Medicare</option></select></div></div>';
  h += '<div class="form-grid"><div class="form-group"><label>Diagnosis</label><input type="text" id="diagnosis"></div><div class="form-group"><label>DX Date</label><input type="date" id="dxDate"></div></div>';
  h += '<div class="form-group"><label>Documents</label><div class="checkbox-group">';
  h += '<label><input type="checkbox" id="docSS"> SS</label>';
  h += '<label><input type="checkbox" id="docID"> ID</label>';
  h += '<label><input type="checkbox" id="docBirth"> BC</label></div></div>';
  h += '<div class="form-group"><label>Notes</label><textarea id="notes"></textarea></div>';
  h += '<div class="button-group"><button type="submit" class="btn btn-primary" id="submitBtn">Add</button><button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button></div></form></div>';
  h += '<div><h2>Entries</h2><div class="filters"><div class="filter-grid">';
  h += '<div class="form-group"><label>Month</label><input type="month" id="fMonth"></div>';
  h += '<div class="form-group"><label>Type</label><select id="fType"><option value="">All</option><option value="Stand-alone CE">CE</option><option value="Internal Referral">Internal Referral</option><option value="External Referral">External Referral</option><option value="HMIS Entry">HMIS Entry</option><option value="MyEvolv Entry">MyEvolv Entry</option></select></div>';
  h += '<div class="form-group"><label>System</label><select id="fSystem"><option value="">All</option><option value="MyEvolv">MyEvolv</option><option value="HMIS">HMIS</option><option value="Both">Both</option></select></div></div>';
  h += '<div class="button-group"><button class="btn btn-primary" onclick="applyFilters()">Apply</button><button class="btn btn-secondary" onclick="clearFilters()">Clear</button><button class="btn btn-success" onclick="exportCSV()">Export CSV</button></div></div>';
  h += '<div class="table-container"><div id="table"></div></div></div></div>';
  document.getElementById('app').innerHTML = h;
  document.getElementById('entryForm').onsubmit = saveEntry;
  var n = new Date();
  var m = n.getFullYear()+'-'+(n.getMonth()<9?'0':'')+(n.getMonth()+1);
  document.getElementById('fMonth').value = m;
}

function showMsg(msg, isError) {
  var el = document.getElementById('formMsg');
  if (el) {
    el.innerHTML = '<div class="'+(isError?'error-msg':'success-msg')+'">'+msg+'</div>';
    setTimeout(function() { el.innerHTML = ''; }, 5000);
  }
}

function saveEntry(evt) {
  evt.preventDefault();
  
  var name = document.getElementById('clientName').value.trim();
  var dob = document.getElementById('dob').value;
  var entryType = document.getElementById('entryType').value;
  var system = document.getElementById('system').value;
  var enrollment = document.getElementById('enrollment').value;
  
  if (!name || !dob || !entryType || !system || !enrollment) {
    showMsg('Please fill in all required fields (*)', true);
    return false;
  }
  
  var d = {
    client_id: 'CLT-' + Date.now(),
    client_name: name,
    entry_date: new Date().toISOString().split('T')[0],
    program: 'PATH',
    program: 'PATH',
    dob: dob,
    hmis_id: document.getElementById('hmisId').value || null,
    case_manager: document.getElementById('caseManager').value || null,
    entry_type: entryType,
    system: system,
    enrollment_status: enrollment,
    encounter_date: document.getElementById('encounterDate').value || null,
    living_situation: document.getElementById('living').value || null,
    voucher_type: document.getElementById('voucherType').value,
    voucher_status: document.getElementById('voucherStatus').value,
    insurance: document.getElementById('insurance').value,
    diagnosis: document.getElementById('diagnosis').value || null,
    diagnosis_date: document.getElementById('dxDate').value || null,
    doc_ss: document.getElementById('docSS').checked,
    doc_id: document.getElementById('docID').checked,
    doc_birth: document.getElementById('docBirth').checked,
    notes: document.getElementById('notes').value || null,
    user_id: user.id,
    user_email: user.email
  };
  
  console.log('Saving entry:', d);
  
  if (editing) {
    sb.from('myevolv_entries').update(d).eq('id', editing.id).then(function(r) {
      console.log('Update response:', r);
      if (r.error) {
        showMsg('Error updating: ' + r.error.message, true);
      } else {
        showMsg('Updated successfully!', false);
        editing = null;
        document.getElementById('submitBtn').textContent = 'Add';
        resetForm();
        loadEntries();
      }
    });
  } else {
    sb.from('myevolv_entries').insert([d]).then(function(r) {
      console.log('Insert response:', r);
      if (r.error) {
        showMsg('Error adding: ' + r.error.message, true);
      } else {
        showMsg('Added successfully!', false);
        resetForm();
        loadEntries();
      }
    });
  }
  return false;
}

function resetForm() {
  document.getElementById('entryForm').reset();
  editing = null;
  document.getElementById('submitBtn').textContent = 'Add';
  var msgEl = document.getElementById('formMsg');
  if (msgEl) msgEl.innerHTML = '';
}

function loadEntries() {
  sb.from('myevolv_entries').select('*').order('created_at',{ascending:false}).then(function(r) {
    console.log('Load entries response:', r);
    if (r.error) {
      console.error('Error loading entries:', r.error);
    } else {
      entries = r.data || [];
      applyFilters();
      updateStats();
    }
  });
}

function updateStats() {
  var t=entries.length, f=0, a=0, y=0;
  for(var i=0;i<entries.length;i++) {
    if(entries[i].enrollment_status==='Fully Enrolled')f++;
    if(entries[i].voucher_status==='Active')a++;
    if(isYouth(entries[i].dob))y++;
  }
  document.getElementById('stats').innerHTML='<div class="stats-grid"><div class="stat-card"><h3>'+t+'</h3><p>Total</p></div><div class="stat-card"><h3>'+f+'</h3><p>Enrolled</p></div><div class="stat-card"><h3>'+a+'</h3><p>Active</p></div><div class="stat-card"><h3>'+y+'</h3><p>Youth</p></div></div>';
}

function calcAge(dob) {
  var bd=new Date(dob), td=new Date();
  var age=td.getFullYear()-bd.getFullYear();
  var m=td.getMonth()-bd.getMonth();
  if(m<0||(m===0&&td.getDate()<bd.getDate()))age--;
  return age;
}

function isYouth(dob) { var age=calcAge(dob); return age>=14&&age<=24; }

function applyFilters() {
  var f=entries.slice();
  var m=document.getElementById('fMonth').value;
  if(m) f=f.filter(function(e){var d=e.encounter_date||e.created_at;return d&&d.indexOf(m)===0;});
  var t=document.getElementById('fType').value;
  if(t) f=f.filter(function(e){return e.entry_type===t;});
  var s=document.getElementById('fSystem').value;
  if(s) f=f.filter(function(e){return e.system===s;});
  renderTable(f);
}

function clearFilters() {
  document.getElementById('fMonth').value='';
  document.getElementById('fType').value='';
  document.getElementById('fSystem').value='';
  applyFilters();
}

function exportCSV() {
  var f=entries.slice();
  var m=document.getElementById('fMonth').value;
  if(m) f=f.filter(function(e){var d=e.encounter_date||e.created_at;return d&&d.indexOf(m)===0;});
  var t=document.getElementById('fType').value;
  if(t) f=f.filter(function(e){return e.entry_type===t;});
  var s=document.getElementById('fSystem').value;
  if(s) f=f.filter(function(e){return e.system===s;});
  
  if(f.length===0) { alert('No entries to export'); return; }
  
  var headers = ['Name','DOB','Age','HMIS ID','Case Manager','Entry Type','System','Enrollment','Encounter Date','Living Situation','Voucher Type','Voucher Status','Insurance','Diagnosis','Docs','Notes'];
  var rows = [headers.join(',')];
  
  for(var i=0;i<f.length;i++) {
    var e=f[i];
    var age=calcAge(e.dob);
    var docs=[];
    if(e.doc_ss)docs.push('SS');
    if(e.doc_id)docs.push('ID');
    if(e.doc_birth)docs.push('BC');
    var row = [
      '"'+(e.client_name||'')+'"',
      e.dob||'',
      age,
      '"'+(e.hmis_id||'')+'"',
      '"'+(e.case_manager||'')+'"',
      '"'+(e.entry_type||'')+'"',
      '"'+(e.system||'')+'"',
      '"'+(e.enrollment_status||'')+'"',
      e.encounter_date||'',
      '"'+(e.living_situation||'')+'"',
      '"'+(e.voucher_type||'')+'"',
      '"'+(e.voucher_status||'')+'"',
      '"'+(e.insurance||'')+'"',
      '"'+(e.diagnosis||'')+'"',
      '"'+docs.join(', ')+'"',
      '"'+(e.notes||'').replace(/"/g,'""')+'"'
    ];
    rows.push(row.join(','));
  }
  
  var csv = rows.join('\n');
  var blob = new Blob([csv], {type:'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'path-entries-'+(m||'all')+'.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function renderTable(data) {
  if(!data||data.length===0) {
    document.getElementById('table').innerHTML='<p style="text-align:center;padding:20px;">No entries</p>';
    return;
  }
  var rows='';
  for(var i=0;i<data.length;i++) {
    var e=data[i];
    var age=calcAge(e.dob);
    var docs=[];
    if(e.doc_ss)docs.push('SS');
    if(e.doc_id)docs.push('ID');
    if(e.doc_birth)docs.push('BC');
    rows+='<tr><td><b>'+e.client_name+'</b></td><td>'+e.dob+' ('+age+')</td><td>'+(e.hmis_id||'-')+'</td><td>'+(e.case_manager||'-')+'</td><td>'+e.entry_type+'</td><td>'+e.system+'</td><td>'+e.enrollment_status+'</td><td>'+(e.living_situation||'-')+'</td><td>'+e.voucher_type+'</td><td>'+e.voucher_status+'</td><td>'+e.insurance+'</td><td>'+(e.diagnosis||'-')+'</td><td>'+(docs.length?docs.join(','):'-')+'</td><td><button class="action-btn edit-btn" onclick="editEntry('+e.id+')">Edit</button><button class="action-btn delete-btn" onclick="deleteEntry('+e.id+')">Del</button></td></tr>';
  }
  document.getElementById('table').innerHTML='<table><thead><tr><th>Name</th><th>DOB</th><th>HMIS</th><th>Mgr</th><th>Type</th><th>System</th><th>Enroll</th><th>Living</th><th>Vouch</th><th>Status</th><th>Ins</th><th>DX</th><th>Docs</th><th>Actions</th></tr></thead><tbody>'+rows+'</tbody></table>';
}

function editEntry(id) {
  var e=null;
  for(var i=0;i<entries.length;i++) { if(entries[i].id===id) { e=entries[i]; break; } }
  if(!e) return;
  editing=e;
  document.getElementById('clientName').value=e.client_name||'';
  document.getElementById('dob').value=e.dob||'';
  document.getElementById('hmisId').value=e.hmis_id||'';
  document.getElementById('caseManager').value=e.case_manager||'';
  document.getElementById('entryType').value=e.entry_type||'';
  document.getElementById('system').value=e.system||'';
  document.getElementById('enrollment').value=e.enrollment_status||'';
  document.getElementById('encounterDate').value=e.encounter_date||'';
  document.getElementById('living').value=e.living_situation||'';
  document.getElementById('voucherType').value=e.voucher_type||'None';
  document.getElementById('voucherStatus').value=e.voucher_status||'Inactive';
  document.getElementById('insurance').value=e.insurance||'None';
  document.getElementById('diagnosis').value=e.diagnosis||'';
  document.getElementById('dxDate').value=e.diagnosis_date||'';
  document.getElementById('docSS').checked=e.doc_ss||false;
  document.getElementById('docID').checked=e.doc_id||false;
  document.getElementById('docBirth').checked=e.doc_birth||false;
  document.getElementById('notes').value=e.notes||'';
  document.getElementById('submitBtn').textContent='Update';
  window.scrollTo(0,0);
}

function deleteEntry(id) {
  if(!confirm('Delete?')) return;
  sb.from('myevolv_entries').delete().eq('id',id).then(function(r) {
    if (r.error) {
      showMsg('Error deleting: ' + r.error.message, true);
    } else {
      showMsg('Deleted!', false);
      loadEntries();
    }
  });
}

init();
</script>
</body>
</html>
