<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyEvolv Entry Tracker v4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .version {
            color: #667eea;
            font-size: 0.9em;
            font-weight: bold;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 10px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .flag-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .flag-ce {
            background: #ffd700;
            color: #856404;
        }

        .flag-youth {
            background: #ff6b6b;
            color: white;
        }

        .flag-active-voucher {
            background: #51cf66;
            color: white;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #fa5252;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .entries-section {
            margin-top: 30px;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
        }

        .edit-btn {
            background: #4dabf7;
            color: white;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .login-container h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success {
            background: #efe;
            color: #363;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://wvvepssoltooeeqqvnul.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2dmVwc3NvbHRvb2VlcXF2bnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDA3MDgsImV4cCI6MjA4MzcxNjcwOH0.xPFDECNheYPrxYTBfQ3IwbUY27UNfqMMojBvnB6ArnQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let entries = [];
        let editingEntry = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                renderApp();
                loadEntries();
            } else {
                renderLogin();
            }

            supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    currentUser = session.user;
                    renderApp();
                    loadEntries();
                } else {
                    currentUser = null;
                    renderLogin();
                }
            });
        }

        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="login-container">
                    <h2>ðŸ”’ MyEvolv Entry Tracker v4.1</h2>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <div class="button-group" style="margin-top: 20px; justify-content: center;">
                        <button class="btn btn-primary" onclick="handleLogin()">Login</button>
                        <button class="btn btn-secondary" onclick="handleSignup()">Sign Up</button>
                    </div>
                    <div id="authMessage"></div>
                </div>
            `;
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('authMessage');

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            
            if (error) {
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function handleSignup() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('authMessage');

            const { error } = await supabase.auth.signUp({ email, password });
            
            if (error) {
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            } else {
                messageDiv.innerHTML = `<div class="success">Check your email for verification link!</div>`;
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
        }

        function renderApp() {
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>ðŸ“‹ MyEvolv Entry Tracker</h1>
                        <p class="version">Version 4.1 - Enhanced Tracking & Reporting</p>
                    </div>

                    <div class="user-info">
                        <span>ðŸ‘¤ Logged in as: <strong>${currentUser.email}</strong></span>
                        <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
                    </div>

                    <div id="statsSection"></div>

                    <div class="form-section">
                        <h2>âž• Add/Edit Entry</h2>
                        <form id="entryForm" onsubmit="handleSubmit(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Client Name *</label>
                                    <input type="text" id="clientName" required>
                                </div>
                                <div class="form-group">
                                    <label>Date of Birth *</label>
                                    <input type="date" id="dob" required>
                                </div>
                                <div class="form-group">
                                    <label>HMIS ID</label>
                                    <input type="text" id="hmisId">
                                </div>
                                <div class="form-group">
                                    <label>Case Manager</label>
                                    <input type="text" id="caseManager">
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Entry Type *</label>
                                    <select id="entryType" required>
                                        <option value="">Select Type</option>
                                        <option value="Stand-alone CE">Stand-alone CE</option>
                                        <option value="Internal Referral">Internal Referral</option>
                                        <option value="External Referral">External Referral</option>
                                        <option value="HMIS Entry">HMIS Entry</option>
                                        <option value="MyEvolv Entry">MyEvolv Entry</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>System *</label>
                                    <select id="system" required>
                                        <option value="">Select System</option>
                                        <option value="MyEvolv">MyEvolv</option>
                                        <option value="HMIS">HMIS</option>
                                        <option value="Both">Both</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enrollment Status *</label>
                                    <select id="enrollmentStatus" required>
                                        <option value="">Select Status</option>
                                        <option value="Fully Enrolled">Fully Enrolled</option>
                                        <option value="Partially Enrolled">Partially Enrolled</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date of Encounter/Assessment</label>
                                    <input type="date" id="encounterDate">
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Current Living Situation/Location</label>
                                    <input type="text" id="livingSituation" placeholder="e.g., Shelter, Street, Friend's Couch">
                                </div>
                                <div class="form-group">
                                    <label>Voucher Type</label>
                                    <select id="voucherType">
                                        <option value="None">None</option>
                                        <option value="COB">COB (City of Bangor RRH)</option>
                                        <option value="PSHP">PSHP</option>
                                        <option value="Section 8">Section 8</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Voucher Status</label>
                                    <select id="voucherStatus">
                                        <option value="Inactive">Inactive</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Active">Active</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Insurance</label>
                                    <select id="insurance">
                                        <option value="None">None</option>
                                        <option value="MaineCare">MaineCare</option>
                                        <option value="Private">Private</option>
                                        <option value="Medicare">Medicare</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Diagnosis (DX)</label>
                                    <input type="text" id="diagnosis" placeholder="Enter diagnosis">
                                </div>
                                <div class="form-group">
                                    <label>Diagnosis Date</label>
                                    <input type="date" id="diagnosisDate">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Documents Ready</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="docSS">
                                        <label for="docSS">Social Security Card</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="docID">
                                        <label for="docID">ID</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="docBirth">
                                        <label for="docBirth">Birth Certificate</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Last Contact Note / Notes</label>
                                <textarea id="notes" placeholder="Enter notes about last contact or general notes..."></textarea>
                            </div>

                            <div class="button-group">
                                <button type="submit" class="btn btn-primary" id="submitBtn">Add Entry</button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
                            </div>
                        </form>
                    </div>

                    <div class="entries-section">
                        <h2>ðŸ“Š Entries & Reports</h2>
                        
                        <div class="filters">
                            <h3>Filters</h3>
                            <div class="filter-grid">
                                <div class="form-group">
                                    <label>Month</label>
                                    <input type="month" id="filterMonth">
                                </div>
                                <div class="form-group">
                                    <label>Entry Type</label>
                                    <select id="filterEntryType">
                                        <option value="">All Types</option>
                                        <option value="Stand-alone CE">Stand-alone CE</option>
                                        <option value="Internal Referral">Internal Referral</option>
                                        <option value="External Referral">External Referral</option>
                                        <option value="HMIS Entry">HMIS Entry</option>
                                        <option value="MyEvolv Entry">MyEvolv Entry</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>System</label>
                                    <select id="filterSystem">
                                        <option value="">All Systems</option>
                                        <option value="MyEvolv">MyEvolv</option>
                                        <option value="HMIS">HMIS</option>
                                        <option value="Both">Both</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enrollment</label>
                                    <select id="filterEnrollment">
                                        <option value="">All</option>
                                        <option value="Fully Enrolled">Fully Enrolled</option>
                                        <option value="Partially Enrolled">Partially Enrolled</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Voucher Status</label>
                                    <select id="filterVoucherStatus">
                                        <option value="">All</option>
                                        <option value="Active">Active Only</option>
                                        <option value="Pending">Pending Only</option>
                                        <option value="Inactive">Inactive Only</option>
                                    </select>
                                </div>
                            </div>
                            <div class="checkbox-group" style="margin-top: 15px;">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="filterCE">
                                    <label for="filterCE">Show CE Only</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="filterYouth">
                                    <label for="filterYouth">Show Youth (14-16) Only</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="filterActiveVoucher">
                                    <label for="filterActiveVoucher">Show Active Vouchers Only</label>
                                </div>
                            </div>
                            <div class="button-group" style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                                <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
                            </div>
                        </div>

                        <div id="entriesTable"></div>
                    </div>
                </div>
            `;

            const now = new Date();
            const monthString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('filterMonth').value = monthString;
        }

        function calculateAge(dob) {
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function isYouth(dob) {
            const age = calculateAge(dob);
            return age >= 14 && age <= 16;
        }

        async function handleSubmit(event) {
            event.preventDefault();

            const entryData = {
                client_name: document.getElementById('clientName').value,
                dob: document.getElementById('dob').value,
                hmis_id: document.getElementById('hmisId').value,
                case_manager: document.getElementById('caseManager').value,
                entry_type: document.getElementById('entryType').value,
                system: document.getElementById('system').value,
                enrollment_status: document.getElementById('enrollmentStatus').value,
                encounter_date: document.getElementById('encounterDate').value,
                living_situation: document.getElementById('livingSituation').value,
                voucher_type: document.getElementById('voucherType').value,
                voucher_status: document.getElementById('voucherStatus').value,
                insurance: document.getElementById('insurance').value,
                diagnosis: document.getElementById('diagnosis').value,
                diagnosis_date: document.getElementById('diagnosisDate').value,
                doc_ss: document.getElementById('docSS').checked,
                doc_id: document.getElementById('docID').checked,
                doc_birth: document.getElementById('docBirth').checked,
                notes: document.getElementById('notes').value,
                user_id: currentUser.id
            };

            try {
                if (editingEntry) {
                    const { error } = await supabase
                        .from('myevolv_entries')
                        .update(entryData)
                        .eq('id', editingEntry.id);

                    if (error) throw error;
                    alert('Entry updated successfully!');
                    editingEntry = null;
                    document.getElementById('submitBtn').textContent = 'Add Entry';
                } else {
                    const { error } = await supabase
                        .from('myevolv_entries')
                        .insert([entryData]);

                    if (error) throw error;
                    alert('Entry added successfully!');
                }

                resetForm();
                loadEntries();
            } catch (error) {
                alert('Error saving entry: ' + error.message);
            }
        }

        function resetForm() {
            document.getElementById('entryForm').reset();
            editingEntry = null;
            document.getElementById('submitBtn').textContent = 'Add Entry';
        }

        async function loadEntries() {
            try {
                const { data, error } = await supabase
                    .from('myevolv_entries')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                entries = data || [];
                applyFilters();
                updateStats();
            } catch (error) {
                console.error('Error loading entries:', error);
                document.getElementById('entriesTable').innerHTML = `
                    <div class="error">Error loading entries: ${error.message}</div>
                `;
            }
        }

        function updateStats() {
            const total = entries.length;
            const fullyEnrolled = entries.filter(e => e.enrollment_status === 'Fully Enrolled').length;
            const activeVouchers = entries.filter(e => e.voucher_status === 'Active').length;
            const youth = entries.filter(e => isYouth(e.dob)).length;

            document.getElementById('statsSection').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${total}</h3>
                        <p>Total Entries</p>
                    </div>
                    <div class="stat-card">
                        <h3>${fullyEnrolled}</h3>
                        <p>Fully Enrolled</p>
                    </div>
                    <div class="stat-card">
                        <h3>${activeVouchers}</h3>
                        <p>Active Vouchers</p>
                    </div>
                    <div class="stat-card">
                        <h3>${youth}</h3>
                        <p>Youth (14-16)</p>
                    </div>
                </div>
            `;
        }

        function applyFilters() {
            let filtered = [...entries];

            const monthFilter = document.getElementById('filterMonth').value;
            if (monthFilter) {
                filtered = filtered.filter(entry => {
                    const entryDate = entry.encounter_date || entry.created_at;
                    return entryDate && entryDate.startsWith(monthFilter);
                });
            }

            const typeFilter = document.getElementById('filterEntryType').value;
            if (typeFilter) {
                filtered = filtered.filter(e => e.entry_type === typeFilter);
            }

            const systemFilter = document.getElementById('filterSystem').value;
            if (systemFilter) {
                filtered = filtered.filter(e => e.system === systemFilter);
            }

            const enrollmentFilter = document.getElementById('filterEnrollment').value;
            if (enrollmentFilter) {
                filtered = filtered.filter(e => e.enrollment_status === enrollmentFilter);
            }

            const voucherFilter = document.getElementById('filterVoucherStatus').value;
            if (voucherFilter) {
                filtered = filtered.filter(e => e.voucher_status === voucherFilter);
            }

            if (document.getElementById('filterCE').checked) {
                filtered = filtered.filter(e => e.entry_type === 'Stand-alone CE');
            }

            if (document.getElementById('filterYouth').checked) {
                filtered = filtered.filter(e => isYouth(e.dob));
            }

            if (document.getElementById('filterActiveVoucher').checked) {
                filtered = filtered.filter(e => e.voucher_status === 'Active');
            }

            renderTable(filtered);
        }

        function clearFilters() {
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterEntryType').value = '';
            document.getElementById('filterSystem').value = '';
            document.getElementById('filterEnrollment').value = '';
            document.getElementById('filterVoucherStatus').value = '';
            document.getElementById('filterCE').checked = false;
            document.getElementById('filterYouth').checked = false;
            document.getElementById('filterActiveVoucher').checked = false;
            applyFilters();
        }

        function renderTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('entriesTable').innerHTML = `
                    <div class="loading">No entries found matching filters.</div>
                `;
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>DOB</th>
                            <th>HMIS ID</th>
                            <th>Case Manager</th>
                            <th>Entry Type</th>
                            <th>System</th>
                            <th>Enrollment</th>
                            <th>Living Situation</th>
                            <th>Voucher</th>
                            <th>Status</th>
                            <th>Insurance</th>
                            <th>Diagnosis</th>
                            <th>Docs</th>
                            <th>Flags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(entry => {
                            const age = calculateAge(entry.dob);
                            const youth = isYouth(entry.dob);
                            const activeVoucher = entry.voucher_status === 'Active';
                            const isCE = entry.entry_type === 'Stand-alone CE';
                            
                            const docs = [];
                            if (entry.doc_ss) docs.push('SS');
                            if (entry.doc_id) docs.push('ID');
                            if (entry.doc_birth) docs.push('BC');
                            const docsText = docs.length > 0 ? docs.join(', ') : 'None';

                            let flags = '';
                            if (isCE) flags += '<span class="flag-indicator flag-ce">CE</span>';
                            if (youth) flags += '<span class="flag-indicator flag-youth">Youth</span>';
                            if (activeVoucher) flags += '<span class="flag-indicator flag-active-voucher">Active</span>';

                            return `
                                <tr>
                                    <td><strong>${entry.client_name}</strong></td>
                                    <td>${entry.dob} (${age})</td>
                                    <td>${entry.hmis_id || '-'}</td>
                                    <td>${entry.case_manager || '-'}</td>
                                    <td>${entry.entry_type}</td>
                                    <td>${entry.system}</td>
                                    <td>${entry.enrollment_status}</td>
                                    <td>${entry.living_situation || '-'}</td>
                                    <td>${entry.voucher_type}</td>
                                    <td>${entry.voucher_status}</td>
                                    <td>${entry.insurance}</td>
                                    <td>${entry.diagnosis || '-'}${entry.diagnosis_date ? '<br><small>' + entry.diagnosis_date + '</small>' : ''}</td>
                                    <td>${docsText}</td>
                                    <td>${flags || '-'}</td>
                                    <td class="action-buttons">
                                        <button class="action-btn edit-btn" onclick="editEntry(${entry.id})">Edit</button>
                                        <button class="action-btn delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('entriesTable').innerHTML = tableHTML;
        }

        async function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            editingEntry = entry;
            
            document.getElementById('clientName').value = entry.client_name;
            document.getElementById('dob').value = entry.dob;
            document.getElementById('hmisId').value = entry.hmis_id || '';
            document.getElementById('caseManager').value = entry.case_manager || '';
            document.getElementById('entryType').value = entry.entry_type;
            document.getElementById('system').value = entry.system;
            document.getElementById('enrollmentStatus').value = entry.enrollment_status;
            document.getElementById('encounterDate').value = entry.encounter_date || '';
            document.getElementById('livingSituation').value = entry.living_situation || '';
            document.getElementById('voucherType').value = entry.voucher_type;
            document.getElementById('voucherStatus').value = entry.voucher_status;
            document.getElementById('insurance').value = entry.insurance;
            document.getElementById('diagnosis').value = entry.diagnosis || '';
            document.getElementById('diagnosisDate').value = entry.diagnosis_date || '';
            document.getElementById('docSS').checked = entry.doc_ss || false;
            document.getElementById('docID').checked = entry.doc_id || false;
            document.getElementById('docBirth').checked = entry.doc_birth || false;
            document.getElementById('notes').value = entry.notes || '';

            document.getElementById('submitBtn').textContent = 'Update Entry';
            
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteEntry(id) {
            if (!confirm('Are you sure you want to delete this entry?')) return;

            try {
                const { error } = await supabase
                    .from('myevolv_entries')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Entry deleted successfully!');
                loadEntries();
            } catch (error) {
                alert('Error deleting entry: ' + error.message);
            }
        }

        function exportToCSV() {
            const monthFilter = document.getElementById('filterMonth').value;
            const monthName = monthFilter ? new Date(monthFilter + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'All';

            let filtered = [...entries];
            
            if (monthFilter) {
                filtered = filtered.filter(entry => {
                    const entryDate = entry.encounter_date || entry.created_at;
                    return entryDate && entryDate.startsWith(monthFilter);
                });
            }

            const typeFilter = document.getElementById('filterEntryType').value;
            if (typeFilter) filtered = filtered.filter(e => e.entry_type === typeFilter);

            const systemFilter = document.getElementById('filterSystem').value;
            if (systemFilter) filtered = filtered.filter(e => e.system === systemFilter);

            const enrollmentFilter = document.getElementById('filterEnrollment').value;
            if (enrollmentFilter) filtered = filtered.filter(e => e.enrollment_status === enrollmentFilter);

            const voucherFilter = document.getElementById('filterVoucherStatus').value;
            if (voucherFilter) filtered = filtered.filter(e => e.voucher_status === voucherFilter);

            if (document.getElementById('filterCE').checked) {
                filtered = filtered.filter(e => e.entry_type === 'Stand-alone CE');
            }

            if (document.getElementById('filterYouth').checked) {
                filtered = filtered.filter(e => isYouth(e.dob));
            }

            if (document.getElementById('filterActiveVoucher').checked) {
                filtered = filtered.filter(e => e.voucher_status === 'Active');
            }

            const headers = [
                'Client Name', 'DOB', 'Age', 'HMIS ID', 'Case Manager', 'Entry Type', 'System',
                'Enrollment Status', 'Encounter Date', 'Living Situation', 'Voucher Type', 
                'Voucher Status', 'Insurance', 'Diagnosis', 'Diagnosis Date',
                'SS Card', 'ID', 'Birth Cert', 'CE Flag', 'Youth Flag', 'Active Voucher Flag', 'Notes'
            ];

            const rows = filtered.map(entry => {
                const age = calculateAge(entry.dob);
                const youth = isYouth(entry.dob);
                const isCE = entry.entry_type === 'Stand-alone CE';
                const activeVoucher = entry.voucher_status === 'Active';

                return [
                    entry.client_name,
                    entry.dob,
                    age,
                    entry.hmis_id || '',
                    entry.case_manager || '',
                    entry.entry_type,
                    entry.system,
                    entry.enrollment_status,
                    entry.encounter_date || '',
                    entry.living_situation || '',
                    entry.voucher_type,
                    entry.voucher_status,
                    entry.insurance,
                    entry.diagnosis || '',
                    entry.diagnosis_date || '',
                    entry.doc_ss ? 'Yes' : 'No',
                    entry.doc_id ? 'Yes' : 'No',
                    entry.doc_birth ? 'Yes' : 'No',
                    isCE ? 'Yes' : 'No',
                    youth ? 'Yes' : 'No',
                    activeVoucher ? 'Yes' : 'No',
                    `"${(entry.notes || '').replace(/"/g, '""')}"`
                ].map(val => `"${val}"`).join(',');
            });

            const csv = [headers.join(','), ...rows].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MyEvolv_Entries_${monthName.replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        init();
    </script>
</body>
</html>
