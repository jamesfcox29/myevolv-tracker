<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyEvolv Entry Tracker v4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-danger {
            background: #dc3545;
        }

        .button-success {
            background: #28a745;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group .button {
            width: auto;
            flex: 1;
        }

        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .entries-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .entries-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        .entries-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .entries-table tbody tr {
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .entries-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .entries-table tbody tr.selected {
            background-color: #e7f3ff;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #333;
            font-size: 1.8em;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .close-button:hover {
            background: #f0f0f0;
        }

        .report-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .report-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .report-item {
            padding: 10px;
            background: white;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-enrollment {
            background: #d4edda;
            color: #155724;
        }

        .badge-housing {
            background: #cce5ff;
            color: #004085;
        }

        .badge-followup {
            background: #fff3cd;
            color: #856404;
        }

        .badge-yes {
            background: #d4edda;
            color: #155724;
        }

        .badge-no {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .entries-table {
                font-size: 0.9em;
            }

            .entries-table th,
            .entries-table td {
                padding: 10px 8px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä MyEvolv Entry Tracker v4.1</h1>
            <p>PATH Program Data Management System - Enhanced Edition</p>
        </div>

        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-number" id="totalEntries">0</div>
                <div class="stat-label">Total Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEnrollments">0</div>
                <div class="stat-label">Enrollments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalHousing">0</div>
                <div class="stat-label">Housing Vouchers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalFollowups">0</div>
                <div class="stat-label">Follow-ups</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentMonth">0</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>

        <div class="content">
            <!-- Add Entry Section -->
            <div class="section">
                <h2 class="section-title">‚ûï Add New Entry</h2>
                <div id="messageContainer"></div>
                
                <form id="entryForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="clientName">Client Name *</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label for="dateOfBirth">Date of Birth</label>
                            <input type="date" id="dateOfBirth">
                        </div>
                        <div class="form-group">
                            <label for="caseManager">Case Manager</label>
                            <input type="text" id="caseManager">
                        </div>
                        <div class="form-group">
                            <label for="entryDate">Entry Date *</label>
                            <input type="date" id="entryDate" required>
                        </div>
                        <div class="form-group">
                            <label for="entryType">Entry Type *</label>
                            <select id="entryType" required>
                                <option value="">Select Type</option>
                                <option value="enrollment">New Enrollment</option>
                                <option value="housing_voucher">Housing Voucher Award</option>
                                <option value="followup">Follow-up Contact</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lastServiceDate">Last Service Date</label>
                            <input type="date" id="lastServiceDate">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="myEvolvCompleted">
                                <label for="myEvolvCompleted">MyEvolv Entry Completed</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="hmisCompleted">
                                <label for="hmisCompleted">HMIS Entry Completed</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="hasInsurance">
                                <label for="hasInsurance">Has Insurance</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="hasSsn">
                                <label for="hasSsn">Has SSN</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 1em;"></textarea>
                    </div>

                    <button type="submit" class="button">Add Entry</button>
                </form>
            </div>

            <!-- View Entries Section -->
            <div class="section">
                <h2 class="section-title">üìã View All Entries</h2>
                
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="filterMonth">Filter by Month</label>
                        <input type="month" id="filterMonth">
                    </div>
                    <div class="filter-group">
                        <label for="filterType">Filter by Type</label>
                        <select id="filterType">
                            <option value="">All Types</option>
                            <option value="enrollment">Enrollments</option>
                            <option value="housing_voucher">Housing Vouchers</option>
                            <option value="followup">Follow-ups</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterCompletion">Filter by Completion</label>
                        <select id="filterCompletion">
                            <option value="">All Entries</option>
                            <option value="both">Both Systems Complete</option>
                            <option value="myevolv">MyEvolv Complete</option>
                            <option value="hmis">HMIS Complete</option>
                            <option value="incomplete">Incomplete</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterCaseManager">Filter by Case Manager</label>
                        <input type="text" id="filterCaseManager" placeholder="Enter name...">
                    </div>
                    <div class="filter-group">
                        <label for="filterClient">Filter by Client</label>
                        <input type="text" id="filterClient" placeholder="Enter client name...">
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="entries-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client Name</th>
                                <th>DOB</th>
                                <th>Case Manager</th>
                                <th>Type</th>
                                <th>Last Service</th>
                                <th>MyEvolv</th>
                                <th>HMIS</th>
                                <th>Insurance</th>
                                <th>SSN</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody">
                            <tr>
                                <td colspan="11" class="loading">Loading entries...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Generate Report Section -->
            <div class="section">
                <h2 class="section-title">üìä Generate Monthly Report</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reportMonth">Select Month *</label>
                        <input type="month" id="reportMonth" required>
                    </div>
                    <div class="form-group">
                        <label for="reportType">Filter by Entry Type</label>
                        <select id="reportType">
                            <option value="">All Types</option>
                            <option value="enrollment">Enrollments Only</option>
                            <option value="housing_voucher">Housing Vouchers Only</option>
                            <option value="followup">Follow-ups Only</option>
                        </select>
                    </div>
                </div>
                
                <button class="button" onclick="generateReport()">Generate Report</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Entry</h2>
                <button class="close-button" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editEntryId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editClientName">Client Name *</label>
                        <input type="text" id="editClientName" required>
                    </div>
                    <div class="form-group">
                        <label for="editDateOfBirth">Date of Birth</label>
                        <input type="date" id="editDateOfBirth">
                    </div>
                    <div class="form-group">
                        <label for="editCaseManager">Case Manager</label>
                        <input type="text" id="editCaseManager">
                    </div>
                    <div class="form-group">
                        <label for="editEntryDate">Entry Date *</label>
                        <input type="date" id="editEntryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editEntryType">Entry Type *</label>
                        <select id="editEntryType" required>
                            <option value="enrollment">New Enrollment</option>
                            <option value="housing_voucher">Housing Voucher Award</option>
                            <option value="followup">Follow-up Contact</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editLastServiceDate">Last Service Date</label>
                        <input type="date" id="editLastServiceDate">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editMyEvolvCompleted">
                            <label for="editMyEvolvCompleted">MyEvolv Entry Completed</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editHmisCompleted">
                            <label for="editHmisCompleted">HMIS Entry Completed</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editHasInsurance">
                            <label for="editHasInsurance">Has Insurance</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editHasSsn">
                            <label for="editHasSsn">Has SSN</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 1em;"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="button button-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="button button-success">Save Changes</button>
                    <button type="button" class="button button-danger" onclick="deleteEntry()">Delete Entry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Monthly Report</h2>
                <button class="close-button" onclick="closeReportModal()">&times;</button>
            </div>
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://wvvepssoltooeeqqvnul.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2dmVwc3NvbHRvb2VlcXF2bnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyODI1NjgsImV4cCI6MjA1MTg1ODU2OH0.xWpNTtj2yOEu3Jfl-XvcgBPbI5SoMb0CaCtZw4wMhZg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allEntries = [];
        let currentEditId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadEntries();
            setupEventListeners();
            setDefaultDates();
        });

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('reportMonth').value = currentMonth;
        }

        function setupEventListeners() {
            document.getElementById('entryForm').addEventListener('submit', handleAddEntry);
            document.getElementById('editForm').addEventListener('submit', handleEditEntry);
            
            // Filter listeners
            document.getElementById('filterMonth').addEventListener('change', applyFilters);
            document.getElementById('filterType').addEventListener('change', applyFilters);
            document.getElementById('filterCompletion').addEventListener('change', applyFilters);
            document.getElementById('filterCaseManager').addEventListener('input', applyFilters);
            document.getElementById('filterClient').addEventListener('input', applyFilters);
        }

        async function loadEntries() {
            try {
                const { data, error } = await supabase
                    .from('myevolv_entries')
                    .select('*')
                    .order('entry_date', { ascending: false });

                if (error) throw error;

                allEntries = data || [];
                updateStats();
                displayEntries(allEntries);
            } catch (error) {
                console.error('Error loading entries:', error);
                showMessage('Error loading entries: ' + error.message, 'error');
            }
        }

        function updateStats() {
            const total = allEntries.length;
            const enrollments = allEntries.filter(e => e.entry_type === 'enrollment').length;
            const housing = allEntries.filter(e => e.entry_type === 'housing_voucher').length;
            const followups = allEntries.filter(e => e.entry_type === 'followup').length;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const thisMonth = allEntries.filter(e => e.entry_date && e.entry_date.startsWith(currentMonth)).length;

            document.getElementById('totalEntries').textContent = total;
            document.getElementById('totalEnrollments').textContent = enrollments;
            document.getElementById('totalHousing').textContent = housing;
            document.getElementById('totalFollowups').textContent = followups;
            document.getElementById('currentMonth').textContent = thisMonth;
        }

        function displayEntries(entries) {
            const tbody = document.getElementById('entriesTableBody');
            
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">No entries found</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(entry => `
                <tr onclick="openEditModal('${entry.id}')">
                    <td>${formatDate(entry.entry_date)}</td>
                    <td>${entry.client_name}</td>
                    <td>${formatDate(entry.dob)}</td>
                    <td>${entry.case_manager || '-'}</td>
                    <td><span class="badge badge-${entry.entry_type}">${formatType(entry.entry_type)}</span></td>
                    <td>${formatDate(entry.last_service_date)}</td>
                    <td><span class="badge badge-${entry.myevolv_completed ? 'yes' : 'no'}">${entry.myevolv_completed ? 'Yes' : 'No'}</span></td>
                    <td><span class="badge badge-${entry.hmis_completed ? 'yes' : 'no'}">${entry.hmis_completed ? 'Yes' : 'No'}</span></td>
                    <td><span class="badge badge-${entry.has_insurance ? 'yes' : 'no'}">${entry.has_insurance ? 'Yes' : 'No'}</span></td>
                    <td><span class="badge badge-${entry.has_ssn ? 'yes' : 'no'}">${entry.has_ssn ? 'Yes' : 'No'}</span></td>
                    <td><button class="button button-secondary" style="padding: 8px 15px; font-size: 0.9em;" onclick="event.stopPropagation(); openEditModal('${entry.id}')">Edit</button></td>
                </tr>
            `).join('');
        }

        function applyFilters() {
            const monthFilter = document.getElementById('filterMonth').value;
            const typeFilter = document.getElementById('filterType').value;
            const completionFilter = document.getElementById('filterCompletion').value;
            const caseManagerFilter = document.getElementById('filterCaseManager').value.toLowerCase();
            const clientFilter = document.getElementById('filterClient').value.toLowerCase();

            let filtered = allEntries;

            if (monthFilter) {
                filtered = filtered.filter(e => e.entry_date && e.entry_date.startsWith(monthFilter));
            }

            if (typeFilter) {
                filtered = filtered.filter(e => e.entry_type === typeFilter);
            }

            if (completionFilter) {
                switch(completionFilter) {
                    case 'both':
                        filtered = filtered.filter(e => e.myevolv_completed && e.hmis_completed);
                        break;
                    case 'myevolv':
                        filtered = filtered.filter(e => e.myevolv_completed);
                        break;
                    case 'hmis':
                        filtered = filtered.filter(e => e.hmis_completed);
                        break;
                    case 'incomplete':
                        filtered = filtered.filter(e => !e.myevolv_completed || !e.hmis_completed);
                        break;
                }
            }

            if (caseManagerFilter) {
                filtered = filtered.filter(e => 
                    e.case_manager && e.case_manager.toLowerCase().includes(caseManagerFilter)
                );
            }

            if (clientFilter) {
                filtered = filtered.filter(e => 
                    e.client_name && e.client_name.toLowerCase().includes(clientFilter)
                );
            }

            displayEntries(filtered);
        }

        async function handleAddEntry(e) {
            e.preventDefault();

            const entry = {
                client_name: document.getElementById('clientName').value,
                dob: document.getElementById('dateOfBirth').value || null,
                case_manager: document.getElementById('caseManager').value || null,
                entry_date: document.getElementById('entryDate').value,
                entry_type: document.getElementById('entryType').value,
                last_service_date: document.getElementById('lastServiceDate').value || null,
                myevolv_completed: document.getElementById('myEvolvCompleted').checked,
                hmis_completed: document.getElementById('hmisCompleted').checked,
                has_insurance: document.getElementById('hasInsurance').checked,
                has_ssn: document.getElementById('hasSsn').checked,
                notes: document.getElementById('notes').value || null
            };

            try {
                const { data, error } = await supabase
                    .from('myevolv_entries')
                    .insert([entry])
                    .select();

                if (error) throw error;

                showMessage('Entry added successfully!', 'success');
                document.getElementById('entryForm').reset();
                setDefaultDates();
                await loadEntries();
            } catch (error) {
                console.error('Error adding entry:', error);
                showMessage('Error adding entry: ' + error.message, 'error');
            }
        }

        function openEditModal(id) {
            const entry = allEntries.find(e => e.id === id);
            if (!entry) return;

            currentEditId = id;
            document.getElementById('editEntryId').value = id;
            document.getElementById('editClientName').value = entry.client_name;
            document.getElementById('editDateOfBirth').value = entry.dob || '';
            document.getElementById('editCaseManager').value = entry.case_manager || '';
            document.getElementById('editEntryDate').value = entry.entry_date;
            document.getElementById('editEntryType').value = entry.entry_type;
            document.getElementById('editLastServiceDate').value = entry.last_service_date || '';
            document.getElementById('editMyEvolvCompleted').checked = entry.myevolv_completed;
            document.getElementById('editHmisCompleted').checked = entry.hmis_completed;
            document.getElementById('editHasInsurance').checked = entry.has_insurance;
            document.getElementById('editHasSsn').checked = entry.has_ssn;
            document.getElementById('editNotes').value = entry.notes || '';

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditId = null;
        }

        async function handleEditEntry(e) {
            e.preventDefault();

            const entry = {
                client_name: document.getElementById('editClientName').value,
                dob: document.getElementById('editDateOfBirth').value || null,
                case_manager: document.getElementById('editCaseManager').value || null,
                entry_date: document.getElementById('editEntryDate').value,
                entry_type: document.getElementById('editEntryType').value,
                last_service_date: document.getElementById('editLastServiceDate').value || null,
                myevolv_completed: document.getElementById('editMyEvolvCompleted').checked,
                hmis_completed: document.getElementById('editHmisCompleted').checked,
                has_insurance: document.getElementById('editHasInsurance').checked,
                has_ssn: document.getElementById('editHasSsn').checked,
                notes: document.getElementById('editNotes').value || null
            };

            try {
                const { error } = await supabase
                    .from('myevolv_entries')
                    .update(entry)
                    .eq('id', currentEditId);

                if (error) throw error;

                showMessage('Entry updated successfully!', 'success');
                closeEditModal();
                await loadEntries();
            } catch (error) {
                console.error('Error updating entry:', error);
                showMessage('Error updating entry: ' + error.message, 'error');
            }
        }

        async function deleteEntry() {
            if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('myevolv_entries')
                    .delete()
                    .eq('id', currentEditId);

                if (error) throw error;

                showMessage('Entry deleted successfully!', 'success');
                closeEditModal();
                await loadEntries();
            } catch (error) {
                console.error('Error deleting entry:', error);
                showMessage('Error deleting entry: ' + error.message, 'error');
            }
        }

        async function generateReport() {
            const month = document.getElementById('reportMonth').value;
            const typeFilter = document.getElementById('reportType').value;
            
            if (!month) {
                alert('Please select a month');
                return;
            }

            let filtered = allEntries.filter(e => e.entry_date && e.entry_date.startsWith(month));
            
            if (typeFilter) {
                filtered = filtered.filter(e => e.entry_type === typeFilter);
            }

            const enrollments = filtered.filter(e => e.entry_type === 'enrollment');
            const housing = filtered.filter(e => e.entry_type === 'housing_voucher');
            const followups = filtered.filter(e => e.entry_type === 'followup');

            const myEvolvComplete = filtered.filter(e => e.myevolv_completed).length;
            const hmisComplete = filtered.filter(e => e.hmis_completed).length;
            const bothComplete = filtered.filter(e => e.myevolv_completed && e.hmis_completed).length;

            const reportHtml = `
                <div class="report-section">
                    <h3>üìÖ Report for ${formatMonthYear(month)} ${typeFilter ? '- ' + formatType(typeFilter) + ' Only' : ''}</h3>
                    <p style="color: #666; margin-bottom: 20px;">Generated on ${new Date().toLocaleDateString()}</p>
                </div>

                <div class="report-section">
                    <h3>üìä Summary Statistics</h3>
                    <div class="report-item"><strong>Total Entries:</strong> ${filtered.length}</div>
                    ${!typeFilter || typeFilter === 'enrollment' ? `<div class="report-item"><strong>New Enrollments:</strong> ${enrollments.length}</div>` : ''}
                    ${!typeFilter || typeFilter === 'housing_voucher' ? `<div class="report-item"><strong>Housing Vouchers Awarded:</strong> ${housing.length}</div>` : ''}
                    ${!typeFilter || typeFilter === 'followup' ? `<div class="report-item"><strong>Follow-up Contacts:</strong> ${followups.length}</div>` : ''}
                    <div class="report-item"><strong>MyEvolv Completed:</strong> ${myEvolvComplete}</div>
                    <div class="report-item"><strong>HMIS Completed:</strong> ${hmisComplete}</div>
                    <div class="report-item"><strong>Both Systems Complete:</strong> ${bothComplete}</div>
                    <div class="report-item"><strong>Completion Rate:</strong> ${filtered.length > 0 ? ((bothComplete / filtered.length) * 100).toFixed(1) : 0}%</div>
                </div>

                ${!typeFilter || typeFilter === 'enrollment' ? `
                <div class="report-section">
                    <h3>üë• New Enrollments (${enrollments.length})</h3>
                    ${enrollments.map(e => `
                        <div class="report-item">
                            <strong>${e.client_name}</strong> - ${formatDate(e.entry_date)}
                            <br>Case Manager: ${e.case_manager || 'Not assigned'}
                            <br>Status: MyEvolv ${e.myevolv_completed ? '‚úì' : '‚úó'} | HMIS ${e.hmis_completed ? '‚úì' : '‚úó'}
                            ${e.notes ? `<br><em>Notes: ${e.notes}</em>` : ''}
                        </div>
                    `).join('') || '<div class="report-item">No enrollments this month</div>'}
                </div>
                ` : ''}

                ${!typeFilter || typeFilter === 'housing_voucher' ? `
                <div class="report-section">
                    <h3>üè† Housing Vouchers (${housing.length})</h3>
                    ${housing.map(e => `
                        <div class="report-item">
                            <strong>${e.client_name}</strong> - ${formatDate(e.entry_date)}
                            <br>Case Manager: ${e.case_manager || 'Not assigned'}
                            <br>Status: MyEvolv ${e.myevolv_completed ? '‚úì' : '‚úó'} | HMIS ${e.hmis_completed ? '‚úì' : '‚úó'}
                            ${e.notes ? `<br><em>Notes: ${e.notes}</em>` : ''}
                        </div>
                    `).join('') || '<div class="report-item">No housing vouchers this month</div>'}
                </div>
                ` : ''}

                ${!typeFilter || typeFilter === 'followup' ? `
                <div class="report-section">
                    <h3>üìû Follow-up Contacts (${followups.length})</h3>
                    ${followups.map(e => `
                        <div class="report-item">
                            <strong>${e.client_name}</strong> - ${formatDate(e.entry_date)}
                            <br>Case Manager: ${e.case_manager || 'Not assigned'}
                            <br>Status: MyEvolv ${e.myevolv_completed ? '‚úì' : '‚úó'} | HMIS ${e.hmis_completed ? '‚úì' : '‚úó'}
                            ${e.notes ? `<br><em>Notes: ${e.notes}</em>` : ''}
                        </div>
                    `).join('') || '<div class="report-item">No follow-ups this month</div>'}
                </div>
                ` : ''}

                <div class="report-section">
                    <h3>‚ö†Ô∏è Incomplete Entries</h3>
                    ${filtered.filter(e => !e.myevolv_completed || !e.hmis_completed).map(e => `
                        <div class="report-item">
                            <strong>${e.client_name}</strong> - ${formatType(e.entry_type)}
                            <br>Missing: ${!e.myevolv_completed ? 'MyEvolv ' : ''}${!e.hmis_completed ? 'HMIS' : ''}
                        </div>
                    `).join('') || '<div class="report-item" style="color: green;">‚úì All entries complete!</div>'}
                </div>
            `;

            document.getElementById('reportContent').innerHTML = reportHtml;
            document.getElementById('reportModal').classList.add('active');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatMonthYear(monthString) {
            const [year, month] = monthString.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        function formatType(type) {
            const types = {
                'enrollment': 'Enrollment',
                'housing_voucher': 'Housing',
                'followup': 'Follow-up'
            };
            return types[type] || type;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
