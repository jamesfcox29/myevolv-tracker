<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PATH Entry Tracker v4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        h1 { color: #333; font-size: 2em; margin-bottom: 10px; }
        .version { color: #667eea; font-size: 0.9em; font-weight: bold; }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 0.9em;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 10px 0;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        .flag-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }
        .flag-ce { background: #ffd700; color: #856404; }
        .flag-youth { background: #ff6b6b; color: white; }
        .flag-active-voucher { background: #51cf66; color: white; }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #51cf66; color: white; }
        .btn-success:hover { background: #40c057; }
        .btn-danger { background: #ff6b6b; color: white; }
        .btn-danger:hover { background: #fa5252; }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .entries-section { margin-top: 30px; }
        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        .action-buttons { display: flex; gap: 5px; }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
        }
        .edit-btn { background: #4dabf7; color: white; }
        .delete-btn { background: #ff6b6b; color: white; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .login-container h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 { font-size: 2em; margin-bottom: 5px; }
        .stat-card p { font-size: 0.9em; opacity: 0.9; }
        .loading { text-align: center; padding: 20px; color: #667eea; }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .success {
            background: #efe;
            color: #363;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            table { font-size: 0.9em; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        const sbUrl = 'https://wvvepssoltooeeqqvnul.supabase.co';
        const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2dmVwc3NvbHRvb2VlcXF2bnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDA3MDgsImV4cCI6MjA4MzcxNjcwOH0.xPFDECNheYPrxYTBfQ3IwbUY27UNfqMMojBvnB6ArnQ';
        const sb = window.supabase.createClient(sbUrl, sbKey);
        let user = null;
        let entries = [];
        let editing = null;

        async function init() {
            const { data: { session } } = await sb.auth.getSession();
            if (session) { user = session.user; renderApp(); loadEntries(); }
            else { renderLogin(); }
            sb.auth.onAuthStateChange((event, session) => {
                if (session) { user = session.user; renderApp(); loadEntries(); }
                else { user = null; renderLogin(); }
            });
        }

        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="login-container">
                    <h2>ðŸ”’ PATH Entry Tracker v4.1</h2>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <div class="button-group" style="margin-top: 20px; justify-content: center;">
                        <button class="btn btn-primary" onclick="doLogin()">Login</button>
                        <button class="btn btn-secondary" onclick="doSignup()">Sign Up</button>
                    </div>
                    <div id="authMsg"></div>
                </div>
            `;
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const { error } = await sb.auth.signInWithPassword({ email, password });
            if (error) document.getElementById('authMsg').innerHTML = `<div class="error">${error.message}</div>`;
        }

        async function doSignup() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const { error } = await sb.auth.signUp({ email, password });
            if (error) document.getElementById('authMsg').innerHTML = `<div class="error">${error.message}</div>`;
            else document.getElementById('authMsg').innerHTML = `<div class="success">Check your email!</div>`;
        }

        async function doLogout() { await sb.auth.signOut(); }

        function renderApp() {
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>ðŸ“‹ PATH Entry Tracker</h1>
                        <p class="version">Version 4.1 - Enhanced Tracking & Reporting</p>
                    </div>
                    <div class="user-info">
                        <span>ðŸ‘¤ ${user.email}</span>
                        <button class="btn btn-secondary" onclick="doLogout()">Logout</button>
                    </div>
                    <div id="stats"></div>
                    <div class="form-section">
                        <h2>âž• Add/Edit Entry</h2>
                        <form id="entryForm" onsubmit="saveEntry(event)">
                            <div class="form-grid">
                                <div class="form-group"><label>Client Name *</label><input type="text" id="clientName" required></div>
                                <div class="form-group"><label>DOB *</label><input type="date" id="dob" required></div>
                                <div class="form-group"><label>HMIS ID</label><input type="text" id="hmisId"></div>
                                <div class="form-group"><label>Case Manager</label><input type="text" id="caseManager"></div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Entry Type *</label>
                                    <select id="entryType" required>
                                        <option value="">Select</option>
                                        <option value="Stand-alone CE">Stand-alone CE</option>
                                        <option value="Internal Referral">Internal Referral</option>
                                        <option value="External Referral">External Referral</option>
                                        <option value="HMIS Entry">HMIS Entry</option>
                                        <option value="MyEvolv Entry">MyEvolv Entry</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>System *</label>
                                    <select id="system" required>
                                        <option value="">Select</option>
                                        <option value="MyEvolv">MyEvolv</option>
                                        <option value="HMIS">HMIS</option>
                                        <option value="Both">Both</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enrollment *</label>
                                    <select id="enrollment" required>
                                        <option value="">Select</option>
                                        <option value="Fully Enrolled">Fully Enrolled</option>
                                        <option value="Partially Enrolled">Partially Enrolled</option>
                                    </select>
                                </div>
                                <div class="form-group"><label>Encounter Date</label><input type="date" id="encounterDate"></div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group"><label>Living Situation</label><input type="text" id="living"></div>
                                <div class="form-group">
                                    <label>Voucher Type</label>
                                    <select id="voucherType">
                                        <option value="None">None</option>
                                        <option value="COB">COB</option>
                                        <option value="PSHP">PSHP</option>
                                        <option value="Section 8">Section 8</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Voucher Status</label>
                                    <select id="voucherStatus">
                                        <option value="Inactive">Inactive</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Active">Active</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Insurance</label>
                                    <select id="insurance">
                                        <option value="None">None</option>
                                        <option value="MaineCare">MaineCare</option>
                                        <option value="Private">Private</option>
                                        <option value="Medicare">Medicare</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group"><label>Diagnosis</label><input type="text" id="diagnosis"></div>
                                <div class="form-group"><label>Diagnosis Date</label><input type="date" id="dxDate"></div>
                            </div>
                            <div class="form-group">
                                <label>Documents Ready</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item"><input type="checkbox" id="docSS"><label for="docSS">Social Security</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="docID"><label for="docID">ID</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="docBirth"><label for="docBirth">Birth Certificate</label></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="notes"></textarea>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary" id="submitBtn">Add Entry</button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
                            </div>
                        </form>
                    </div>
                    <div class="entries-section">
                        <h2>ðŸ“Š Entries & Reports</h2>
                        <div class="filters">
                            <h3>Filters</h3>
                            <div class="filter-grid">
                                <div class="form-group"><label>Month</label><input type="month" id="fMonth"></div>
                                <div class="form-group">
                                    <label>Entry Type</label>
                                    <select id="fType">
                                        <option value="">All</option>
                                        <option value="Stand-alone CE">Stand-alone CE</option>
                                        <option value="Internal Referral">Internal Referral</option>
                                        <option value="External Referral">External Referral</option>
                                        <option value="HMIS Entry">HMIS Entry</option>
                                        <option value="MyEvolv Entry">MyEvolv Entry</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>System</label>
                                    <select id="fSystem">
                                        <option value="">All</option>
                                        <option value="MyEvolv">MyEvolv</option>
                                        <option value="HMIS">HMIS</option>
                                        <option value="Both">Both</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Enrollment</label>
                                    <select id="fEnrollment">
                                        <option value="">All</option>
                                        <option value="Fully Enrolled">Fully</option>
                                        <option value="Partially Enrolled">Partial</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Voucher Status</label>
                                    <select id="fVoucher">
                                        <option value="">All</option>
                                        <option value="Active">Active</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="checkbox-group" style="margin-top:15px;">
                                <div class="checkbox-item"><input type="checkbox" id="fCE"><label for="fCE">CE Only</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="fYouth"><label for="fYouth">Youth (14-16)</label></div>
                                <div class="checkbox-item"><input type="checkbox" id="fActiveV"><label for="fActiveV">Active Vouchers</label></div>
                            </div>
                            <div class="button-group" style="margin-top:15px;">
                                <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
                                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                                <button class="btn btn-success" onclick="exportCSV()">Export CSV</button>
                            </div>
                        </div>
                        <div id="table"></div>
                    </div>
                </div>
            `;
            const now = new Date();
            document.getElementById('fMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        }

        function calcAge(dob) {
            const bd = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - bd.getFullYear();
            const m = today.getMonth() - bd.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) age--;
            return age;
        }

        function isYouth(dob) {
            const age = calcAge(dob);
            return age >= 14 && age <= 16;
        }

        async function saveEntry(e) {
            e.preventDefault();
            const data = {
                client_name: document.getElementById('clientName').value,
                dob: document.getElementById('dob').value,
                hmis_id: document.getElementById('hmisId').value,
                case_manager: document.getElementById('caseManager').value,
                entry_type: document.getElementById('entryType').value,
                system: document.getElementById('system').value,
                enrollment_status: document.getElementById('enrollment').value,
                encounter_date: document.getElementById('encounterDate').value,
                living_situation: document.getElementById('living').value,
                voucher_type: document.getElementById('voucherType').value,
                voucher_status: document.getElementById('voucherStatus').value,
                insurance: document.getElementById('insurance').value,
                diagnosis: document.getElementById('diagnosis').value,
                diagnosis_date: document.getElementById('dxDate').value,
                doc_ss: document.getElementById('docSS').checked,
                doc_id: document.getElementById('docID').checked,
                doc_birth: document.getElementById('docBirth').checked,
                notes: document.getElementById('notes').value,
                user_id: user.id
            };
            try {
                if (editing) {
                    await sb.from('myevolv_entries').update(data).eq('id', editing.id);
                    alert('Updated!');
                    editing = null;
                    document.getElementById('submitBtn').textContent = 'Add Entry';
                } else {
                    await sb.from('myevolv_entries').insert([data]);
                    alert('Added!');
                }
                resetForm();
                loadEntries();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function resetForm() {
            document.getElementById('entryForm').reset();
            editing = null;
            document.getElementById('submitBtn').textContent = 'Add Entry';
        }

        async function loadEntries() {
            try {
                const { data, error } = await sb.from('myevolv_entries').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                entries = data || [];
                applyFilters();
                updateStats();
            } catch (err) {
                document.getElementById('table').innerHTML = `<div class="error">${err.message}</div>`;
            }
        }

        function updateStats() {
            const total = entries.length;
            const full = entries.filter(e => e.enrollment_status === 'Fully Enrolled').length;
            const active = entries.filter(e => e.voucher_status === 'Active').length;
            const youth = entries.filter(e => isYouth(e.dob)).length;
            document.getElementById('stats').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card"><h3>${total}</h3><p>Total</p></div>
                    <div class="stat-card"><h3>${full}</h3><p>Fully Enrolled</p></div>
                    <div class="stat-card"><h3>${active}</h3><p>Active Vouchers</p></div>
                    <div class="stat-card"><h3>${youth}</h3><p>Youth (14-16)</p></div>
                </div>
            `;
        }

        function applyFilters() {
            let filtered = [...entries];
            const month = document.getElementById('fMonth').value;
            if (month) filtered = filtered.filter(e => {
                const d = e.encounter_date || e.created_at;
                return d && d.startsWith(month);
            });
            const type = document.getElementById('fType').value;
            if (type) filtered = filtered.filter(e => e.entry_type === type);
            const sys = document.getElementById('fSystem').value;
            if (sys) filtered = filtered.filter(e => e.system === sys);
            const enr = document.getElementById('fEnrollment').value;
            if (enr) filtered = filtered.filter(e => e.enrollment_status === enr);
            const vou = document.getElementById('fVoucher').value;
            if (vou) filtered = filtered.filter(e => e.voucher_status === vou);
            if (document.getElementById('fCE').checked) filtered = filtered.filter(e => e.entry_type === 'Stand-alone CE');
            if (document.getElementById('fYouth').checked) filtered = filtered.filter(e => isYouth(e.dob));
            if (document.getElementById('fActiveV').checked) filtered = filtered.filter(e => e.voucher_status === 'Active');
            renderTable(filtered);
        }

        function clearFilters() {
            document.getElementById('fMonth').value = '';
            document.getElementById('fType').value = '';
            document.getElementById('fSystem').value = '';
            document.getElementById('fEnrollment').value = '';
            document.getElementById('fVoucher').value = '';
            document.getElementById('fCE').checked = false;
            document.getElementById('fYouth').checked = false;
            document.getElementById('fActiveV').checked = false;
            applyFilters();
        }

        function renderTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('table').innerHTML = '<div class="loading">No entries found</div>';
                return;
            }
            const rows = data.map(e => {
                const age = calcAge(e.dob);
                const youth = isYouth(e.dob);
                const activeV = e.voucher_status === 'Active';
                const ce = e.entry_type === 'Stand-alone CE';
                const docs = [];
                if (e.doc_ss) docs.push('SS');
                if (e.doc_id) docs.push('ID');
                if (e.doc_birth) docs.push('BC');
                let flags = '';
                if (ce) flags += '<span class="flag-indicator flag-ce">CE</span>';
                if (youth) flags += '<span class="flag-indicator flag-youth">Youth</span>';
                if (activeV) flags += '<span class="flag-indicator flag-active-voucher">Active</span>';
                return `
                    <tr>
                        <td><strong>${e.client_name}</strong></td>
                        <td>${e.dob} (${age})</td>
                        <td>${e.hmis_id || '-'}</td>
                        <td>${e.case_manager || '-'}</td>
                        <td>${e.entry_type}</td>
                        <td>${e.system}</td>
                        <td>${e.enrollment_status}</td>
                        <td>${e.living_situation || '-'}</td>
                        <td>${e.voucher_type}</td>
                        <td>${e.voucher_status}</td>
                        <td>${e.insurance}</td>
                        <td>${e.diagnosis || '-'}${e.diagnosis_date ? '<br><small>'+e.diagnosis_date+'</small>' : ''}</td>
                        <td>${docs.length ? docs.join(', ') : 'None'}</td>
                        <td>${flags || '-'}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editEntry(${e.id})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteEntry(${e.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('table').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th><th>DOB</th><th>HMIS ID</th><th>Case Mgr</th><th>Type</th>
                            <th>System</th><th>Enrollment</th><th>Living</th><th>Voucher</th>
                            <th>Status</th><th>Insurance</th><th>Diagnosis</th><th>Docs</th>
                            <th>Flags</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        async function editEntry(id) {
            const e = entries.find(x => x.id === id);
            if (!e) return;
            editing = e;
            document.getElementById('clientName').value = e.client_name;
            document.getElementById('dob').value = e.dob;
            document.getElementById('hmisId').value = e.hmis_id || '';
            document.getElementById('caseManager').value = e.case_manager || '';
            document.getElementById('entryType').value = e.entry_type;
            document.getElementById('system').value = e.system;
            document.getElementById('enrollment').value = e.enrollment_status;
            document.getElementById('encounterDate').value = e.encounter_date || '';
            document.getElementById('living').value = e.living_situation || '';
            document.getElementById('voucherType').value = e.voucher_type;
            document.getElementById('voucherStatus').value = e.voucher_status;
            document.getElementById('insurance').value = e.insurance;
            document.getElementById('diagnosis').value = e.diagnosis || '';
            document.getElementById('dxDate').value = e.diagnosis_date || '';
            document.getElementById('docSS').checked = e.doc_ss || false;
            document.getElementById('docID').checked = e.doc_id || false;
            document.getElementById('docBirth').checked = e.doc_birth || false;
            document.getElementById('notes').value = e.notes || '';
            document.getElementById('submitBtn').textContent = 'Update Entry';
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteEntry(id) {
            if (!confirm('Delete this entry?')) return;
            try {
                await sb.from('myevolv_entries').delete().eq('id', id);
                alert('Deleted!');
                loadEntries();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function exportCSV() {
            const month = document.getElementById('fMonth').value;
            const monthName = month ? new Date(month+'-01').toLocaleDateString('en-US', {month:'long', year:'numeric'}) : 'All';
            let filtered = [...entries];
            if (month) filtered = filtered.filter(e => {
                const d = e.encounter_date || e.created_at;
                return d && d.startsWith(month);
            });
            const type = document.getElementById('fType').value;
            if (type) filtered = filtered.filter(e => e.entry_type === type);
            const sys = document.getElementById('fSystem').value;
            if (sys) filtered = filtered.filter(e => e.system === sys);
            const enr = document.getElementById('fEnrollment').value;
            if (enr) filtered = filtered.filter(e => e.enrollment_status === enr);
            const vou = document.getElementById('fVoucher').value;
            if (vou) filtered = filtered.filter(e => e.voucher_status === vou);
            if (document.getElementById('fCE').checked) filtered = filtered.filter(e => e.entry_type === 'Stand-alone CE');
            if (document.getElementById('fYouth').checked) filtered = filtered.filter(e => isYouth(e.dob));
            if (document.getElementById('fActiveV').checked) filtered = filtered.filter(e => e.voucher_status === 'Active');
            
            const headers = ['Name','DOB','Age','HMIS ID','Case Mgr','Type','System','Enrollment','Encounter','Living','Voucher','Status','Insurance','Diagnosis','DX Date','SS','ID','BC','CE','Youth','Active','Notes'];
            const rows = filtered.map(e => {
                const age = calcAge(e.dob);
                const youth = isYouth(e.dob);
                const ce = e.entry_type === 'Stand-alone CE';
                const activeV = e.voucher_status === 'Active';
                return [
                    e.client_name, e.dob, age, e.hmis_id||'', e.case_manager||'',
                    e.entry_type, e.system, e.enrollment_status, e.encounter_date||'',
                    e.living_situation||'', e.voucher_type, e.voucher_status, e.insurance,
                    e.diagnosis||'', e.diagnosis_date||'',
                    e.doc_ss?'Yes':'No', e.doc_id?'Yes':'No', e.doc_birth?'Yes':'No',
                    ce?'Yes':'No', youth?'Yes':'No', activeV?'Yes':'No',
                    `"${(e.notes||'').replace(/"/g,'""')}"`
                ].map(v => `"${v}"`).join(',');
            });
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PATH_Entries_${monthName.replace(' ','_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        init();
    </script>
</body>
</html>