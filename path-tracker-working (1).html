<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PATH Entry Tracker v4.1</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 100%; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; }
.header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }
h1 { color: #333; font-size: 1.8em; margin-bottom: 10px; }
.version { color: #667eea; font-size: 0.9em; }
.user-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.form-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.form-section h2 { color: #667eea; margin-bottom: 15px; font-size: 1.2em; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; }
.form-group { display: flex; flex-direction: column; }
.form-group label { font-weight: 600; margin-bottom: 5px; color: #555; font-size: 0.85em; }
.form-group input, .form-group select, .form-group textarea { padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; }
.form-group textarea { resize: vertical; min-height: 60px; }
.checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; padding: 8px 0; }
.btn { padding: 10px 25px; border: none; border-radius: 6px; font-size: 0.95em; font-weight: 600; cursor: pointer; margin-right: 8px; }
.btn-primary { background: #667eea; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-success { background: #51cf66; color: white; }
.button-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; }
.stat-card h3 { font-size: 1.8em; margin-bottom: 5px; }
.stat-card p { font-size: 0.85em; }
.filters { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
.table-container { overflow-x: auto; margin-top: 15px; }
table { width: 100%; min-width: 1200px; border-collapse: collapse; background: white; font-size: 0.85em; }
th { background: #667eea; color: white; padding: 10px 8px; text-align: left; font-weight: 600; }
td { padding: 8px; border-bottom: 1px solid #eee; }
tr:hover { background: #f8f9fa; }
.action-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; margin: 2px; }
.edit-btn { background: #4dabf7; color: white; }
.delete-btn { background: #ff6b6b; color: white; }
.login-container { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; }
.login-container h2 { color: #667eea; text-align: center; margin-bottom: 30px; }
.hidden { display: none; }
</style>
</head>
<body>

<div id="loginView" class="login-container">
  <h2>PATH Entry Tracker v4.1</h2>
  <div class="form-group">
    <label>Email</label>
    <input type="email" id="loginEmail">
  </div>
  <div class="form-group" style="margin-top: 15px;">
    <label>Password</label>
    <input type="password" id="loginPassword">
  </div>
  <div class="button-group" style="margin-top: 20px; justify-content: center;">
    <button class="btn btn-primary" id="loginBtn">Login</button>
    <button class="btn btn-secondary" id="signupBtn">Sign Up</button>
  </div>
  <div id="authMsg"></div>
</div>

<div id="appView" class="container hidden">
  <div class="header">
    <h1>PATH Entry Tracker</h1>
    <p class="version">Version 4.1</p>
  </div>
  
  <div class="user-info">
    <span id="userEmail"></span>
    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
  </div>
  
  <div id="statsSection"></div>
  
  <div class="form-section">
    <h2>Add/Edit Entry</h2>
    <form id="entryForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Client Name *</label>
          <input type="text" id="clientName" required>
        </div>
        <div class="form-group">
          <label>DOB *</label>
          <input type="date" id="dob" required>
        </div>
        <div class="form-group">
          <label>HMIS ID</label>
          <input type="text" id="hmisId">
        </div>
        <div class="form-group">
          <label>Case Manager</label>
          <input type="text" id="caseManager">
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Entry Type *</label>
          <select id="entryType" required>
            <option value="">Select</option>
            <option value="Stand-alone CE">Stand-alone CE</option>
            <option value="Internal Referral">Internal Referral</option>
            <option value="External Referral">External Referral</option>
            <option value="HMIS Entry">HMIS Entry</option>
            <option value="MyEvolv Entry">MyEvolv Entry</option>
          </select>
        </div>
        <div class="form-group">
          <label>System *</label>
          <select id="system" required>
            <option value="">Select</option>
            <option value="MyEvolv">MyEvolv</option>
            <option value="HMIS">HMIS</option>
            <option value="Both">Both</option>
          </select>
        </div>
        <div class="form-group">
          <label>Enrollment *</label>
          <select id="enrollment" required>
            <option value="">Select</option>
            <option value="Fully Enrolled">Fully Enrolled</option>
            <option value="Partially Enrolled">Partially Enrolled</option>
          </select>
        </div>
        <div class="form-group">
          <label>Encounter Date</label>
          <input type="date" id="encounterDate">
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Living Situation</label>
          <input type="text" id="living">
        </div>
        <div class="form-group">
          <label>Voucher Type</label>
          <select id="voucherType">
            <option value="None">None</option>
            <option value="COB">COB</option>
            <option value="PSHP">PSHP</option>
            <option value="Section 8">Section 8</option>
          </select>
        </div>
        <div class="form-group">
          <label>Voucher Status</label>
          <select id="voucherStatus">
            <option value="Inactive">Inactive</option>
            <option value="Pending">Pending</option>
            <option value="Active">Active</option>
          </select>
        </div>
        <div class="form-group">
          <label>Insurance</label>
          <select id="insurance">
            <option value="None">None</option>
            <option value="MaineCare">MaineCare</option>
            <option value="Private">Private</option>
            <option value="Medicare">Medicare</option>
          </select>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Diagnosis</label>
          <input type="text" id="diagnosis">
        </div>
        <div class="form-group">
          <label>Diagnosis Date</label>
          <input type="date" id="dxDate">
        </div>
      </div>
      
      <div class="form-group">
        <label>Documents Ready</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="docSS"> Social Security</label>
          <label><input type="checkbox" id="docID"> ID</label>
          <label><input type="checkbox" id="docBirth"> Birth Certificate</label>
        </div>
      </div>
      
      <div class="form-group">
        <label>Notes</label>
        <textarea id="notes"></textarea>
      </div>
      
      <div class="button-group">
        <button type="submit" class="btn btn-primary" id="submitBtn">Add Entry</button>
        <button type="button" class="btn btn-secondary" id="clearBtn">Clear</button>
      </div>
    </form>
  </div>
  
  <div>
    <h2 style="margin-bottom: 15px;">Entries & Reports</h2>
    <div class="filters">
      <h3 style="margin-bottom: 10px;">Filters</h3>
      <div class="filter-grid">
        <div class="form-group">
          <label>Month</label>
          <input type="month" id="fMonth">
        </div>
        <div class="form-group">
          <label>Entry Type</label>
          <select id="fType">
            <option value="">All</option>
            <option value="Stand-alone CE">Stand-alone CE</option>
            <option value="Internal Referral">Internal Referral</option>
            <option value="External Referral">External Referral</option>
          </select>
        </div>
        <div class="form-group">
          <label>System</label>
          <select id="fSystem">
            <option value="">All</option>
            <option value="MyEvolv">MyEvolv</option>
            <option value="HMIS">HMIS</option>
            <option value="Both">Both</option>
          </select>
        </div>
        <div class="form-group">
          <label>Enrollment</label>
          <select id="fEnrollment">
            <option value="">All</option>
            <option value="Fully Enrolled">Fully Enrolled</option>
            <option value="Partially Enrolled">Partially Enrolled</option>
          </select>
        </div>
        <div class="form-group">
          <label>Voucher Status</label>
          <select id="fVoucher">
            <option value="">All</option>
            <option value="Active">Active</option>
            <option value="Pending">Pending</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>
      </div>
      <div class="checkbox-group" style="margin-top: 10px;">
        <label><input type="checkbox" id="fCE"> CE Only</label>
        <label><input type="checkbox" id="fYouth"> Youth (14-16)</label>
        <label><input type="checkbox" id="fActiveV"> Active Vouchers</label>
      </div>
      <div class="button-group" style="margin-top: 10px;">
        <button class="btn btn-primary" id="applyFiltersBtn">Apply</button>
        <button class="btn btn-secondary" id="clearFiltersBtn">Clear</button>
        <button class="btn btn-success" id="exportBtn">Export CSV</button>
      </div>
    </div>
    <div class="table-container">
      <div id="tableSection"></div>
    </div>
  </div>
</div>

<script>
var supabaseUrl = 'https://wvvepssoltooeeqqvnul.supabase.co';
var supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2dmVwc3NvbHRvb2VlcXF2bnVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDA3MDgsImV4cCI6MjA4MzcxNjcwOH0.xPFDECNheYPrxYTBfQ3IwbUY27UNfqMMojBvnB6ArnQ';
var supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

var currentUser = null;
var allEntries = [];
var editingEntryId = null;

function initApp() {
  supabase.auth.getSession().then(function(response) {
    if (response.data.session) {
      currentUser = response.data.session.user;
      showAppView();
      loadAllEntries();
    } else {
      showLoginView();
    }
  });
  
  supabase.auth.onAuthStateChange(function(event, session) {
    if (session) {
      currentUser = session.user;
      showAppView();
      loadAllEntries();
    } else {
      currentUser = null;
      showLoginView();
    }
  });
  
  setupEventListeners();
}

function setupEventListeners() {
  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('signupBtn').addEventListener('click', handleSignup);
  document.getElementById('logoutBtn').addEventListener('click', handleLogout);
  document.getElementById('entryForm').addEventListener('submit', handleSubmit);
  document.getElementById('clearBtn').addEventListener('click', clearForm);
  document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
  document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
  document.getElementById('exportBtn').addEventListener('click', exportToCSV);
}

function showLoginView() {
  document.getElementById('loginView').classList.remove('hidden');
  document.getElementById('appView').classList.add('hidden');
}

function showAppView() {
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('appView').classList.remove('hidden');
  document.getElementById('userEmail').textContent = currentUser.email;
  
  var now = new Date();
  var month = now.getFullYear() + '-';
  if (now.getMonth() + 1 < 10) {
    month += '0';
  }
  month += (now.getMonth() + 1);
  document.getElementById('fMonth').value = month;
}

function handleLogin() {
  var email = document.getElementById('loginEmail').value;
  var password = document.getElementById('loginPassword').value;
  
  supabase.auth.signInWithPassword({
    email: email,
    password: password
  }).then(function(response) {
    if (response.error) {
      document.getElementById('authMsg').innerHTML = '<p style="color:red;margin-top:10px;">' + response.error.message + '</p>';
    }
  });
}

function handleSignup() {
  var email = document.getElementById('loginEmail').value;
  var password = document.getElementById('loginPassword').value;
  
  supabase.auth.signUp({
    email: email,
    password: password
  }).then(function(response) {
    if (response.error) {
      document.getElementById('authMsg').innerHTML = '<p style="color:red;margin-top:10px;">' + response.error.message + '</p>';
    } else {
      document.getElementById('authMsg').innerHTML = '<p style="color:green;margin-top:10px;">Check your email for verification!</p>';
    }
  });
}

function handleLogout() {
  supabase.auth.signOut();
}

function handleSubmit(event) {
  event.preventDefault();
  
  var entryData = {
    client_name: document.getElementById('clientName').value,
    dob: document.getElementById('dob').value,
    hmis_id: document.getElementById('hmisId').value,
    case_manager: document.getElementById('caseManager').value,
    entry_type: document.getElementById('entryType').value,
    system: document.getElementById('system').value,
    enrollment_status: document.getElementById('enrollment').value,
    encounter_date: document.getElementById('encounterDate').value,
    living_situation: document.getElementById('living').value,
    voucher_type: document.getElementById('voucherType').value,
    voucher_status: document.getElementById('voucherStatus').value,
    insurance: document.getElementById('insurance').value,
    diagnosis: document.getElementById('diagnosis').value,
    diagnosis_date: document.getElementById('dxDate').value,
    doc_ss: document.getElementById('docSS').checked,
    doc_id: document.getElementById('docID').checked,
    doc_birth: document.getElementById('docBirth').checked,
    notes: document.getElementById('notes').value,
    user_id: currentUser.id
  };
  
  if (editingEntryId) {
    supabase.from('myevolv_entries')
      .update(entryData)
      .eq('id', editingEntryId)
      .then(function(response) {
        if (response.error) {
          alert('Error updating: ' + response.error.message);
        } else {
          alert('Entry updated successfully!');
          editingEntryId = null;
          document.getElementById('submitBtn').textContent = 'Add Entry';
          clearForm();
          loadAllEntries();
        }
      });
  } else {
    supabase.from('myevolv_entries')
      .insert([entryData])
      .then(function(response) {
        if (response.error) {
          alert('Error adding: ' + response.error.message);
        } else {
          alert('Entry added successfully!');
          clearForm();
          loadAllEntries();
        }
      });
  }
}

function clearForm() {
  document.getElementById('entryForm').reset();
  editingEntryId = null;
  document.getElementById('submitBtn').textContent = 'Add Entry';
}

function loadAllEntries() {
  supabase.from('myevolv_entries')
    .select('*')
    .order('created_at', { ascending: false })
    .then(function(response) {
      if (response.error) {
        alert('Error loading entries: ' + response.error.message);
      } else {
        allEntries = response.data || [];
        updateStats();
        applyFilters();
      }
    });
}

function updateStats() {
  var total = allEntries.length;
  var fullyEnrolled = 0;
  var activeVouchers = 0;
  var youthCount = 0;
  
  for (var i = 0; i < allEntries.length; i++) {
    if (allEntries[i].enrollment_status === 'Fully Enrolled') {
      fullyEnrolled++;
    }
    if (allEntries[i].voucher_status === 'Active') {
      activeVouchers++;
    }
    if (isYouth(allEntries[i].dob)) {
      youthCount++;
    }
  }
  
  var html = '<div class="stats-grid">';
  html += '<div class="stat-card"><h3>' + total + '</h3><p>Total Entries</p></div>';
  html += '<div class="stat-card"><h3>' + fullyEnrolled + '</h3><p>Fully Enrolled</p></div>';
  html += '<div class="stat-card"><h3>' + activeVouchers + '</h3><p>Active Vouchers</p></div>';
  html += '<div class="stat-card"><h3>' + youthCount + '</h3><p>Youth (14-16)</p></div>';
  html += '</div>';
  
  document.getElementById('statsSection').innerHTML = html;
}

function calculateAge(dob) {
  var birthDate = new Date(dob);
  var today = new Date();
  var age = today.getFullYear() - birthDate.getFullYear();
  var monthDiff = today.getMonth() - birthDate.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  return age;
}

function isYouth(dob) {
  var age = calculateAge(dob);
  return age >= 14 && age <= 16;
}

function applyFilters() {
  var filtered = allEntries.slice();
  
  var monthFilter = document.getElementById('fMonth').value;
  if (monthFilter) {
    filtered = filtered.filter(function(entry) {
      var entryDate = entry.encounter_date || entry.created_at;
      return entryDate && entryDate.indexOf(monthFilter) === 0;
    });
  }
  
  var typeFilter = document.getElementById('fType').value;
  if (typeFilter) {
    filtered = filtered.filter(function(entry) {
      return entry.entry_type === typeFilter;
    });
  }
  
  var systemFilter = document.getElementById('fSystem').value;
  if (systemFilter) {
    filtered = filtered.filter(function(entry) {
      return entry.system === systemFilter;
    });
  }
  
  var enrollmentFilter = document.getElementById('fEnrollment').value;
  if (enrollmentFilter) {
    filtered = filtered.filter(function(entry) {
      return entry.enrollment_status === enrollmentFilter;
    });
  }
  
  var voucherFilter = document.getElementById('fVoucher').value;
  if (voucherFilter) {
    filtered = filtered.filter(function(entry) {
      return entry.voucher_status === voucherFilter;
    });
  }
  
  if (document.getElementById('fCE').checked) {
    filtered = filtered.filter(function(entry) {
      return entry.entry_type === 'Stand-alone CE';
    });
  }
  
  if (document.getElementById('fYouth').checked) {
    filtered = filtered.filter(function(entry) {
      return isYouth(entry.dob);
    });
  }
  
  if (document.getElementById('fActiveV').checked) {
    filtered = filtered.filter(function(entry) {
      return entry.voucher_status === 'Active';
    });
  }
  
  renderTable(filtered);
}

function clearFilters() {
  document.getElementById('fMonth').value = '';
  document.getElementById('fType').value = '';
  document.getElementById('fSystem').value = '';
  document.getElementById('fEnrollment').value = '';
  document.getElementById('fVoucher').value = '';
  document.getElementById('fCE').checked = false;
  document.getElementById('fYouth').checked = false;
  document.getElementById('fActiveV').checked = false;
  applyFilters();
}

function renderTable(entries) {
  if (!entries || entries.length === 0) {
    document.getElementById('tableSection').innerHTML = '<p style="text-align:center;padding:20px;color:#667eea;">No entries found matching filters</p>';
    return;
  }
  
  var html = '<table><thead><tr>';
  html += '<th>Name</th><th>DOB</th><th>HMIS ID</th><th>Case Mgr</th><th>Type</th>';
  html += '<th>System</th><th>Enrollment</th><th>Living</th><th>Voucher</th><th>Status</th>';
  html += '<th>Insurance</th><th>Diagnosis</th><th>Docs</th><th>Actions</th>';
  html += '</tr></thead><tbody>';
  
  for (var i = 0; i < entries.length; i++) {
    var entry = entries[i];
    var age = calculateAge(entry.dob);
    
    var docs = [];
    if (entry.doc_ss) docs.push('SS');
    if (entry.doc_id) docs.push('ID');
    if (entry.doc_birth) docs.push('BC');
    var docsText = docs.length > 0 ? docs.join(', ') : 'None';
    
    html += '<tr>';
    html += '<td><strong>' + entry.client_name + '</strong></td>';
    html += '<td>' + entry.dob + ' (' + age + ')</td>';
    html += '<td>' + (entry.hmis_id || '-') + '</td>';
    html += '<td>' + (entry.case_manager || '-') + '</td>';
    html += '<td>' + entry.entry_type + '</td>';
    html += '<td>' + entry.system + '</td>';
    html += '<td>' + entry.enrollment_status + '</td>';
    html += '<td>' + (entry.living_situation || '-') + '</td>';
    html += '<td>' + entry.voucher_type + '</td>';
    html += '<td>' + entry.voucher_status + '</td>';
    html += '<td>' + entry.insurance + '</td>';
    html += '<td>' + (entry.diagnosis || '-') + '</td>';
    html += '<td>' + docsText + '</td>';
    html += '<td>';
    html += '<button class="action-btn edit-btn" data-id="' + entry.id + '">Edit</button>';
    html += '<button class="action-btn delete-btn" data-id="' + entry.id + '">Delete</button>';
    html += '</td>';
    html += '</tr>';
  }
  
  html += '</tbody></table>';
  
  document.getElementById('tableSection').innerHTML = html;
  
  var editButtons = document.querySelectorAll('.edit-btn');
  for (var j = 0; j < editButtons.length; j++) {
    editButtons[j].addEventListener('click', handleEdit);
  }
  
  var deleteButtons = document.querySelectorAll('.delete-btn');
  for (var k = 0; k < deleteButtons.length; k++) {
    deleteButtons[k].addEventListener('click', handleDelete);
  }
}

function handleEdit(event) {
  var entryId = event.target.getAttribute('data-id');
  var entry = null;
  
  for (var i = 0; i < allEntries.length; i++) {
    if (allEntries[i].id == entryId) {
      entry = allEntries[i];
      break;
    }
  }
  
  if (!entry) return;
  
  editingEntryId = entryId;
  
  document.getElementById('clientName').value = entry.client_name || '';
  document.getElementById('dob').value = entry.dob || '';
  document.getElementById('hmisId').value = entry.hmis_id || '';
  document.getElementById('caseManager').value = entry.case_manager || '';
  document.getElementById('entryType').value = entry.entry_type || '';
  document.getElementById('system').value = entry.system || '';
  document.getElementById('enrollment').value = entry.enrollment_status || '';
  document.getElementById('encounterDate').value = entry.encounter_date || '';
  document.getElementById('living').value = entry.living_situation || '';
  document.getElementById('voucherType').value = entry.voucher_type || 'None';
  document.getElementById('voucherStatus').value = entry.voucher_status || 'Inactive';
  document.getElementById('insurance').value = entry.insurance || 'None';
  document.getElementById('diagnosis').value = entry.diagnosis || '';
  document.getElementById('dxDate').value = entry.diagnosis_date || '';
  document.getElementById('docSS').checked = entry.doc_ss || false;
  document.getElementById('docID').checked = entry.doc_id || false;
  document.getElementById('docBirth').checked = entry.doc_birth || false;
  document.getElementById('notes').value = entry.notes || '';
  
  document.getElementById('submitBtn').textContent = 'Update Entry';
  
  document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
}

function handleDelete(event) {
  var entryId = event.target.getAttribute('data-id');
  
  if (!confirm('Are you sure you want to delete this entry?')) {
    return;
  }
  
  supabase.from('myevolv_entries')
    .delete()
    .eq('id', entryId)
    .then(function(response) {
      if (response.error) {
        alert('Error deleting: ' + response.error.message);
      } else {
        alert('Entry deleted successfully!');
        loadAllEntries();
      }
    });
}

function exportToCSV() {
  var monthFilter = document.getElementById('fMonth').value;
  var monthName = monthFilter ? new Date(monthFilter + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'All';
  
  var filtered = allEntries.slice();
  
  if (monthFilter) {
    filtered = filtered.filter(function(entry) {
      var entryDate = entry.encounter_date || entry.created_at;
      return entryDate && entryDate.indexOf(monthFilter) === 0;
    });
  }
  
  var headers = ['Client Name', 'DOB', 'Age', 'HMIS ID', 'Case Manager', 'Entry Type', 'System', 'Enrollment Status', 'Encounter Date', 'Living Situation', 'Voucher Type', 'Voucher Status', 'Insurance', 'Diagnosis', 'Diagnosis Date', 'SS Card', 'ID', 'Birth Cert', 'Notes'];
  
  var rows = [];
  for (var i = 0; i < filtered.length; i++) {
    var entry = filtered[i];
    var age = calculateAge(entry.dob);
    
    var row = [
      entry.client_name,
      entry.dob,
      age,
      entry.hmis_id || '',
      entry.case_manager || '',
      entry.entry_type,
      entry.system,
      entry.enrollment_status,
      entry.encounter_date || '',
      entry.living_situation || '',
      entry.voucher_type,
      entry.voucher_status,
      entry.insurance,
      entry.diagnosis || '',
      entry.diagnosis_date || '',
      entry.doc_ss ? 'Yes' : 'No',
      entry.doc_id ? 'Yes' : 'No',
      entry.doc_birth ? 'Yes' : 'No',
      '"' + (entry.notes || '').replace(/"/g, '""') + '"'
    ];
    
    var rowStr = '';
    for (var j = 0; j < row.length; j++) {
      if (j > 0) rowStr += ',';
      rowStr += '"' + row[j] + '"';
    }
    rows.push(rowStr);
  }
  
  var csv = headers.join(',') + '\n' + rows.join('\n');
  
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = 'PATH_Entries_' + monthName.replace(' ', '_') + '_' + new Date().toISOString().split('T')[0] + '.csv';
  link.click();
  URL.revokeObjectURL(url);
}

initApp();
</script>

</body>
</html>
